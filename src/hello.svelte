<!--
 AList File Browser Component
 Author: OpenList Plugin
 Description: Display AList file manager in SiYuan note sidebar
-->
<script lang="ts">
import { onDestroy, onMount } from "svelte";
import { pushMsg } from "./api";
import { inputDialog } from "./libs/dialog";
export let plugin;

    // i18n support - use plugin's built-in i18n data
    let i18nData = plugin.i18n || {};
    
    // i18n translation function
    function t(key: string, params?: Record<string, any>): string {
        const keys = key.split('.');
        let value = i18nData;
        
        for (const k of keys) {
            if (value && typeof value === 'object' && k in value) {
                value = value[k];
            } else {
                console.warn(`i18n key not found: ${key}`);
                return key; // return key as fallback
            }
        }
        
        if (typeof value !== 'string') {
            console.warn(`i18n value is not string: ${key}`);
            return key;
        }
        
        // Replace parameters if provided
        if (params) {
            return value.replace(/\{(\w+)\}/g, (match, paramKey) => {
                return params[paramKey] || match;
            });
        }
        
        return value;
    }

    let isLoading = false;
    let isLoggedIn = false;
    let currentPath = "/";
    let files = [];
    let error = "";
    let token = "";
    let showUpload = false;
    let uploadFiles = [];
    let uploadMode = "stream";
    let addAsTask = false;
    let overwriteExisting = false;
    let tryInstantUpload = true;
    let isUploading = false;
    let uploadProgress = 0;

    // Preview related variables
    let showPreview = false;
    let previewContent = "";
    let previewFile = null;
    let isLoadingPreview = false;

    // Function group related variables
    let showFunctionGroup = false;
    let activeTab = "folder";
    let newFolderName = "";
    let isCreatingFolder = false;
    let selectedFolders = new Set();
    let isDeletingFolders = false;
    let selectedFiles = new Set<string>();
    let isDeletingFiles = false;

    // Upload tab related variables
    let uploadTab = "online"; // "online" or "offline"
    
    // Offline download related variables
    let downloadUrls = "";
    let isOfflineDownloading = false;
    
    // Task list related variables
    let tasks = [];
    let isLoadingTasks = false;
    
    // Move function related variables
    let showMoveDialog = false;
    let moveTargetPath = "/";
    let folderTree = [];
    let expandedFolders = new Set(); // Record expanded folder paths
    let isLoadingFolderTree = false;
    let isMoving = false;
    let allowOverwrite = false;
    let moveItem = null;
    let loadingSubfolders = new Set(); // Record paths of subfolders being loaded // Information of file or folder to move

    onMount(async () => {
        console.log('AList Browser component mounted with i18n data:', Object.keys(i18nData).length, 'keys');
        await initializeAList();
        setupFolderInput();
    });

    onDestroy(() => {
        console.log("AList file browser closed");
    });

    /**
     * Initialize AList connection
     */
    async function initializeAList() {
        const autoLogin = plugin.settingUtils.get("autoLogin");
        if (autoLogin) {
            await loginAndLoadFiles();
        }
    }

    /**
     * Login and load file list
     */
    async function loginAndLoadFiles() {
        const serverUrl = plugin.settingUtils.get("serverUrl");
        const username = plugin.settingUtils.get("username");
        const password = plugin.settingUtils.get("password");
        const rootPath = plugin.settingUtils.get("rootPath") || "/";
        // Get last visited path, use root path if none
        const lastPath = plugin.settingUtils.get("lastPath") || rootPath;

        if (!serverUrl || !username || !password) {
            error = t('errors.configRequired');
            return;
        }

        isLoading = true;
        error = "";

        try {
            const loginResponse = await plugin.loginToAList(serverUrl, username, password);
            token = loginResponse.token;
            // Save token to settings for use elsewhere
            await plugin.settingUtils.setAndSave("token", token);
            isLoggedIn = true;
            currentPath = lastPath;
            await loadFiles(currentPath);
        } catch (err) {
            console.error("Login failed:", err);
            // Detailed error classification and handling
            if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                error = t('errors.networkError');
            } else if (err.message.includes('401') || err.message.includes('Unauthorized')) {
                error = t('errors.authError');
            } else if (err.message.includes('403') || err.message.includes('Forbidden')) {
                error = t('errors.forbiddenError');
            } else if (err.message.includes('404') || err.message.includes('Not Found')) {
                error = t('errors.notFoundError');
            } else if (err.message.includes('timeout')) {
                error = t('errors.timeoutError');
            } else {
                error = `‚ùå ${t('login')} ${t('errors.unknownError')}: ${err.message || t('errors.unknownError')}`;
            }
            isLoggedIn = false;
        } finally {
            isLoading = false;
        }
    }

    /**
     * Load file list for specified path
     * @param {string} path - File path
     * @param {boolean} forceRefresh - Whether to force refresh, not using cache
     */
    async function loadFiles(path, forceRefresh = false) {
        if (!isLoggedIn || !token) {
            error = t('errors.loginRequired');
            return;
        }

        isLoading = true;
        error = "";

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            const response = await fetch(`${serverUrl}/api/fs/list`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({
                    path: path,
                    password: "",
                    page: 1,
                    per_page: 0,
                    refresh: forceRefresh
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            if (data.code !== 200) {
                throw new Error(data.message || t('errors.failedToGetFileList'));
            }

            files = data.data.content || [];
            currentPath = path;
            // Save current path to settings for restoration on next open
            await plugin.settingUtils.setAndSave("lastPath", path);
        } catch (err) {
            console.error("Load files failed:", err);
            // Detailed error classification and handling
            if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                error = t('errors.networkError');
            } else if (err.message.includes('401') || err.message.includes('Unauthorized')) {
                error = t('errors.loginExpired');
                isLoggedIn = false;
                token = "";
            } else if (err.message.includes('403') || err.message.includes('Forbidden')) {
                error = t('errors.accessDenied');
                isLoggedIn = false;
                token = "";
            } else if (err.message.includes('404') || err.message.includes('Not Found')) {
                error = t('errors.pathNotFound');
            } else if (err.message.includes('timeout')) {
                error = t('errors.loadTimeout');
            } else {
                error = `‚ùå ${t('loading')} ${t('errors.unknownError')}: ${err.message || t('errors.unknownError')}`;
            }
        } finally {
            isLoading = false;
        }
    }

    /**
     * Enter folder
     */
    async function enterFolder(folderName) {
        const newPath = currentPath === "/" ? `/${folderName}` : `${currentPath}/${folderName}`;
        await loadFiles(newPath);
    }

    /**
     * Go back to parent directory
     */
    async function goBack() {
        if (currentPath === "/") return;
        const parentPath = currentPath.substring(0, currentPath.lastIndexOf("/")) || "/";
        await loadFiles(parentPath);
    }

    /**
     * Format file size
     */
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    /**
     * Format date
     */
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    /**
     * Get file icon
     */
    function getFileIcon(file) {
        if (file.is_dir) {
            return "üìÅ";
        }
        const ext = file.name.split('.').pop()?.toLowerCase();
        switch (ext) {
            case 'txt': case 'md': case 'doc': case 'docx':
                return "üìÑ";
            case 'jpg': case 'jpeg': case 'png': case 'gif': case 'bmp':
                return "üñºÔ∏è";
            case 'mp4': case 'avi': case 'mov': case 'wmv':
                return "üé¨";
            case 'mp3': case 'wav': case 'flac': case 'aac':
                return "üéµ";
            case 'zip': case 'rar': case '7z': case 'tar':
                return "üì¶";
            case 'pdf':
                return "üìï";
            default:
                return "üìÑ";
        }
    }



    /**
     * Close upload dialog
     */
    function closeUploadDialog() {
        showUpload = false;
        uploadFiles = [];
        isUploading = false;
        uploadProgress = 0;
    }

    /**
     * Handle file selection
     */
    function handleFileSelect(event) {
        const files = Array.from(event.target.files);
        uploadFiles = [...uploadFiles, ...files];
    }

    /**
     * Handle folder selection
     */
    function handleFolderSelect(event) {
        const files = Array.from(event.target.files);
        uploadFiles = [...uploadFiles, ...files];
    }

    /**
     * ËÆæÁΩÆÊñá‰ª∂Â§πËæìÂÖ•ÁöÑÂ±ûÊÄß
     */
    function setupFolderInput() {
        const folderInput = document.getElementById('folder-input');
        if (folderInput) {
            folderInput.setAttribute('webkitdirectory', '');
        }
    }

    /**
     * ÁßªÈô§ÈÄâ‰∏≠ÁöÑÊñá‰ª∂
     */
    function removeFile(index) {
        uploadFiles = uploadFiles.filter((_, i) => i !== index);
    }

    /**
     * ÊâßË°åÊñá‰ª∂‰∏ä‰º†
     */
    async function uploadFilesToAList() {
        if (uploadFiles.length === 0) {
            error = t('errors.selectFiles');
            return;
        }

        isUploading = true;
        error = "";
        uploadProgress = 0;

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            
            for (let i = 0; i < uploadFiles.length; i++) {
                const file = uploadFiles[i];
                const formData = new FormData();
                
                // ÊûÑÂª∫Êñá‰ª∂Ë∑ØÂæÑ
                const filePath = file.webkitRelativePath || file.name;
                const fullPath = currentPath === "/" ? `/${filePath}` : `${currentPath}/${filePath}`;
                
                formData.append('file', file);
                formData.append('path', currentPath);
                formData.append('as_task', addAsTask.toString());
                
                const response = await fetch(`${serverUrl}/api/fs/put`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': token,
                        'File-Path': encodeURIComponent(fullPath),
                        'As-Task': addAsTask.toString(),
                        'Content-Length': file.size.toString()
                    },
                    body: file
                });

                if (!response.ok) {
                    throw new Error(`${t('upload')} failed: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                if (result.code !== 200) {
                    throw new Error(result.message || `${t('upload')} failed`);
                }

                uploadProgress = Math.round(((i + 1) / uploadFiles.length) * 100);
            }

            // ‰∏ä‰º†ÂÆåÊàêÂêéÂà∑Êñ∞Êñá‰ª∂ÂàóË°®ÔºàÂº∫Âà∂Âà∑Êñ∞‰ª•Á°Æ‰øùÊñ∞‰∏ä‰º†ÁöÑÊñá‰ª∂ÊòæÁ§∫Ôºâ
            await loadFiles(currentPath, true);
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫ÂíåÂà∑Êñ∞ÊèêÈÜí
            await pushMsg(`Successfully uploaded ${uploadFiles.length} files! Due to AList background transfer characteristics, if files are not displayed immediately, please click the refresh button.`);
            closeUploadDialog();
            
        } catch (err) {
            console.error("Upload failed:", err);
            error = `${t('upload')} failed: ${err.message || t('errors.unknownError')}`;
        } finally {
            isUploading = false;
        }
    }

    /**
     * ‰∏ãËΩΩÊñá‰ª∂
     */
    async function downloadFile(file) {
        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            const filePath = currentPath === "/" ? `/${file.name}` : `${currentPath}/${file.name}`;
            
            // Ëé∑ÂèñÊñá‰ª∂ÁöÑ‰∏ãËΩΩÈìæÊé•
            const response = await fetch(`${serverUrl}/api/fs/get`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({
                    path: filePath
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to get file info: ${response.status}`);
            }
            
            const result = await response.json();
            if (result.code !== 200) {
                throw new Error(result.message || t('errors.failedToGetFileInfo'));
            }
            
            const fileInfo = result.data;
            const downloadUrl = fileInfo.raw_url || `${serverUrl}/d${filePath}`;
            
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•Âπ∂Ëß¶Âèë‰∏ãËΩΩ
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = file.name;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        } catch (err) {
            console.error("Download failed:", err);
            error = `${t('download')} failed: ${err.message || t('errors.unknownError')}`;
        }
    }

    /**
     * Âú®ÊÄùÊ∫êÁ¨îËÆ∞ÂÖâÊ†á‰ΩçÁΩÆÂµåÂÖ•AListÊñá‰ª∂ÈìæÊé•
     */
    /**
     * ÂµåÂÖ• AList Êñá‰ª∂ÈìæÊé•Âà∞ÊÄùÊ∫êÁ¨îËÆ∞
     */
    async function embedAListLink(file) {
        try {
            const filePath = currentPath === "/" ? `/${file.name}` : `${currentPath}/${file.name}`;
            
            // ‰ΩøÁî®Ëá™ÂÆö‰πâÂçèËÆÆ alist:// Ê†ºÂºè
            const alistLink = `alist://${encodeURIComponent(filePath)}`;
            
            // ÂàõÂª∫ÂºïÁî®ÂùóÊ†ºÂºèÔºåÈÅøÂÖç‰∏éÊÄùÊ∫êÁ¨îËÆ∞Êü•ËØ¢ÂµåÂÖ•ÂùóÂÜ≤Á™Å
            // ‰ΩøÁî®ÁÆÄÂåñÁöÑÊ†ºÂºèÔºåÂè™ÊòæÁ§∫Êñá‰ª∂ÂêçÂíåAListÂõæÊ†á
            const blockContent = `> üÖ∞Ô∏è **AList File**: [${file.name}](${alistLink})`;
            
            console.log('Generated AList link:', alistLink);
            console.log('Block content:', blockContent);
            
            // ‰ΩøÁî®ÊÄùÊ∫êÁ¨îËÆ∞APIÊèíÂÖ•Ëá™ÂÆö‰πâÂùó
            if (window.siyuan && window.siyuan.ws) {
                // Ëé∑ÂèñÂΩìÂâçÊ¥ªÂä®ÁöÑÁºñËæëÂô®
                const protyle = document.querySelector('.protyle:not(.fn__none) .protyle-wysiwyg');
                if (protyle) {
                    // ÊèíÂÖ•Ëá™ÂÆö‰πâÂùóÂÜÖÂÆπ
                    document.execCommand('insertText', false, blockContent);
                    await pushMsg(`AList file block embedded: ${file.name}`);
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÊ¥ªÂä®ÁºñËæëÂô®ÔºåÂàôÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø
                    await navigator.clipboard.writeText(blockContent);
                    await pushMsg(`File block copied to clipboard: ${file.name}`);
                }
            } else {
                // Â§áÁî®ÊñπÊ°àÔºöÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø
                await navigator.clipboard.writeText(blockContent);
                await pushMsg(`File block copied to clipboard: ${file.name}`);
            }
            
        } catch (err) {
             console.error("Embed AList link failed:", err);
             error = `${t('embed')} failed: ${err.message || t('errors.unknownError')}`;
         }
    }

    /**
     * ÊòæÁ§∫Êñá‰ª∂È¢ÑËßàÂØπËØùÊ°Ü
     */
    async function showFilePreview(file) {
        previewFile = file;
        showPreview = true;
        isLoadingPreview = true;
        previewContent = "";
        
        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            const filePath = currentPath === "/" ? `/${file.name}` : `${currentPath}/${file.name}`;
            
            // È¶ñÂÖàÂ∞ùËØïËé∑ÂèñÊñá‰ª∂ÁöÑÁõ¥Êé•‰∏ãËΩΩÈìæÊé•
            const response = await fetch(`${serverUrl}/api/fs/get`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({
                    path: filePath
                })
            });
            
            if (!response.ok) {
                throw new Error(`Ëé∑ÂèñÊñá‰ª∂‰ø°ÊÅØÂ§±Ë¥•: ${response.status}`);
            }
            
            const result = await response.json();
            if (result.code !== 200) {
                throw new Error(result.message || 'Failed to get file info');
            }
            
            const fileInfo = result.data;
            
            // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÁîüÊàêÈ¢ÑËßàÂÜÖÂÆπ
            if (file.name.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)) {
                // ÂõæÁâáÈ¢ÑËßà
                const imageUrl = fileInfo.raw_url || `${serverUrl}/d${filePath}`;
                previewContent = `
                    <div class="obj-box hope-stack">
                        <div class="hope-stack">
                            <img class="hope-image" src="${imageUrl}" alt="${file.name}" style="max-width: 100%; height: auto;" />
                        </div>
                    </div>
                `;
            } else if (file.name.match(/\.(mp4|webm|ogg|avi|mov)$/i)) {
                // ËßÜÈ¢ëÈ¢ÑËßà
                const videoUrl = fileInfo.raw_url || `${serverUrl}/d${filePath}`;
                previewContent = `
                    <div class="obj-box hope-stack">
                        <div class="hope-stack">
                            <video controls style="max-width: 100%; height: auto;">
                                <source src="${videoUrl}" type="video/mp4">
                                Your browser does not support video playback.
                            </video>
                        </div>
                    </div>
                `;
            } else if (file.name.match(/\.(mp3|wav|ogg|flac|aac)$/i)) {
                // Èü≥È¢ëÈ¢ÑËßà
                const audioUrl = fileInfo.raw_url || `${serverUrl}/d${filePath}`;
                previewContent = `
                    <div class="obj-box hope-stack">
                        <div class="hope-stack">
                            <audio controls style="width: 100%;">
                                <source src="${audioUrl}" type="audio/mpeg">
                                Your browser does not support audio playback.
                            </audio>
                        </div>
                    </div>
                `;
            } else if (file.name.match(/\.(pdf)$/i)) {
                // PDF Êñá‰ª∂È¢ÑËßà
                const fileUrl = encodeURIComponent(fileInfo.raw_url || `${serverUrl}/d${filePath}`);
                previewContent = `
                    <div class="obj-box hope-stack">
                        <div class="hope-stack">
                            <iframe 
                                src="https://res.oplist.org/pdf.js/web/viewer.html?file=${fileUrl}" 
                                style="width: 100%; height: 600px; border: none;"
                                title="PDF Preview">
                            </iframe>
                        </div>
                    </div>
                `;
            } else if (file.name.match(/\.(doc|docx|xls|xlsx|ppt|pptx)$/i)) {
                // Office ÊñáÊ°£È¢ÑËßà - ‰ΩøÁî® Microsoft È¢ÑËßàÊúçÂä°
                const fileUrl = encodeURIComponent(fileInfo.raw_url || `${serverUrl}/d${filePath}`);
                previewContent = `
                    <div class="obj-box hope-stack">
                        <div class="hope-stack">
                            <iframe 
                                src="https://view.officeapps.live.com/op/view.aspx?src=${fileUrl}" 
                                style="width: 100%; height: 600px; border: none;"
                                title="Office Document Preview"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            </iframe>
                            <div style="display: none; text-align: center; padding: 40px; background: #f8f9fa; border-radius: 4px;">
                                <p style="margin-bottom: 16px; color: #6c757d;">Preview service is temporarily unavailable, please try downloading the file to view</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (file.name.match(/\.(epub)$/i)) {
                // EPUB ÁîµÂ≠ê‰π¶È¢ÑËßà
                const fileUrl = encodeURIComponent(fileInfo.raw_url || `${serverUrl}/d${filePath}`);
                previewContent = `
                    <div class="obj-box hope-stack">
                        <div class="hope-stack">
                            <iframe 
                                src="https://res.oplist.org/epub.js/viewer.html?url=${fileUrl}" 
                                style="width: 100%; height: 600px; border: none;"
                                title="EPUB Preview">
                            </iframe>
                        </div>
                    </div>
                `;
            } else if (file.name.match(/\.(md)$/i)) {
                // Markdown Êñá‰ª∂È¢ÑËßà - Ê∏≤Êüì‰∏∫ HTML
                try {
                    const textUrl = fileInfo.raw_url || `${serverUrl}/d${filePath}`;
                    const textResponse = await fetch(textUrl, {
                        headers: {
                            'Authorization': token
                        }
                    });
                    const markdownContent = await textResponse.text();
                    
                    // ÁÆÄÂçïÁöÑ Markdown Ê∏≤Êüì
                    let htmlContent = markdownContent
                        .replace(/### (.*)/g, '<h3>$1</h3>')
                        .replace(/## (.*)/g, '<h2>$1</h2>')
                        .replace(/# (.*)/g, '<h1>$1</h1>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/`(.*?)`/g, '<code>$1</code>')
                        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                        .replace(/^- (.*)/gm, '<li>$1</li>')
                        .replace(/((<li>.*<\/li>\s*)+)/g, '<ul>$1</ul>')
                        .replace(/\n\n/g, '</p><p>')
                        .replace(/^(.*)$/gm, function(match) {
                            if (match.startsWith('<h') || match.startsWith('<ul') || match.startsWith('<li') || match.trim() === '') {
                                return match;
                            }
                            return match;
                        });
                    
                    htmlContent = '<p>' + htmlContent + '</p>';
                    htmlContent = htmlContent.replace(/<p><\/p>/g, '').replace(/<p>(<h[1-6]>)/g, '$1').replace(/(<\/h[1-6]>)<\/p>/g, '$1');
                    
                    previewContent = `
                        <div class="obj-box hope-stack">
                            <div class="hope-stack">
                                <div style="max-height: 500px; overflow-y: auto; padding: 20px; background: var(--b3-theme-surface); border-radius: 4px; line-height: 1.6;">
                                    ${htmlContent}
                                </div>
                            </div>
                        </div>
                    `;
                } catch (textErr) {
                    throw new Error(t('errors.unableToLoadMarkdown'));
                }
            } else if (file.name.match(/\.(txt|json|xml|html|css|js|ts|py|java|cpp|c|h)$/i)) {
                // ÂÖ∂‰ªñÊñáÊú¨Êñá‰ª∂È¢ÑËßà
                try {
                    const textUrl = fileInfo.raw_url || `${serverUrl}/d${filePath}`;
                    const textResponse = await fetch(textUrl, {
                        headers: {
                            'Authorization': token
                        }
                    });
                    const textContent = await textResponse.text();
                    previewContent = `
                        <div class="obj-box hope-stack">
                            <div class="hope-stack">
                                <pre style="white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto; padding: 16px; background: var(--b3-theme-surface); border-radius: 4px;">${textContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                            </div>
                        </div>
                    `;
                } catch (textErr) {
                    throw new Error(t('errors.unableToLoadText'));
                }
            } else {
                // ‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã
                previewContent = `
                    <div class="obj-box hope-stack">
                        <div class="hope-stack" style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                            <h3>${file.name}</h3>
                            <p>This file type is not supported for preview</p>
                            <p>File size: ${formatFileSize(file.size)}</p>
                        </div>
                    </div>
                `;
            }
            
        } catch (err) {
            console.error("Preview failed:", err);
            previewContent = `<div class="preview-error">${t('errors.previewFailed')}: ${err.message}</div>`;
        } finally {
            isLoadingPreview = false;
        }
    }

    /**
     * ÂÖ≥Èó≠È¢ÑËßàÂØπËØùÊ°Ü
     */
    function closePreview() {
        showPreview = false;
        previewContent = "";
        previewFile = null;
        isLoadingPreview = false;
    }

    /**
     * ÊòæÁ§∫ÂäüËÉΩÁªÑÂØπËØùÊ°Ü
     */
    function showFunctionGroupDialog() {
        showFunctionGroup = true;
        activeTab = "folder";
        newFolderName = "";
        selectedFolders.clear();
    }

    /**
     * ÂÖ≥Èó≠ÂäüËÉΩÁªÑÂØπËØùÊ°Ü
     */
    function closeFunctionGroupDialog() {
        showFunctionGroup = false;
        activeTab = "folder";
        newFolderName = "";
        selectedFolders.clear();
    }

    /**
     * ÂàáÊç¢ÂäüËÉΩÁªÑÊ†áÁ≠æÈ°µ
     */
    function switchTab(tab) {
        activeTab = tab;
        // Â¶ÇÊûúÂàáÊç¢Âà∞‰ªªÂä°Ê†áÁ≠æÈ°µÔºåËá™Âä®Âä†ËΩΩ‰ªªÂä°ÂàóË°®
        if (tab === "task") {
            loadUndoneTasks();
        }
    }

    /**
     * Êñ∞Âª∫Êñá‰ª∂Â§π
     */
    async function createFolder() {
        if (!newFolderName.trim()) {
            error = t('errors.enterFolderName');
            return;
        }

        isCreatingFolder = true;
        error = "";

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            const folderPath = currentPath === "/" ? `/${newFolderName}` : `${currentPath}/${newFolderName}`;
            
            const response = await fetch(`${serverUrl}/api/fs/mkdir`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({
                    path: folderPath
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to create folder: ${response.status}`);
            }
            
            const result = await response.json();
            if (result.code !== 200) {
                throw new Error(result.message || t('errors.failedToCreateFolder'));
            }
            
            // Âà∑Êñ∞Êñá‰ª∂ÂàóË°®ÔºàÂº∫Âà∂Âà∑Êñ∞‰ª•Á°Æ‰øùÂà†Èô§ÁöÑÊñá‰ª∂‰∏çÂÜçÊòæÁ§∫Ôºâ
            await loadFiles(currentPath, true);
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            await pushMsg(t('messages.folderCreatedSuccess', {name: newFolderName}));
            newFolderName = "";
            
        } catch (err) {
            console.error("Create folder failed:", err);
            error = `${t('messages.failedToCreateFolder')}: ${err.message || t('errors.unknownError')}`;
        } finally {
            isCreatingFolder = false;
        }
    }

    /**
     * ÂàáÊç¢Êñá‰ª∂Â§πÈÄâÊã©Áä∂ÊÄÅ
     */
    function toggleFolderSelection(folderName) {
        if (selectedFolders.has(folderName)) {
            selectedFolders.delete(folderName);
        } else {
            selectedFolders.add(folderName);
        }
        selectedFolders = selectedFolders; // Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞
    }

    /**
     * Âà†Èô§ÈÄâ‰∏≠ÁöÑÊñá‰ª∂Â§π
     */
    async function deleteSelectedFolders() {
        if (selectedFolders.size === 0) {
            error = t('errors.selectFoldersToDelete');
            return;
        }

        if (!confirm(t('messages.confirmDeleteFolders', {count: selectedFolders.size}))) {
            return;
        }

        isDeletingFolders = true;
        error = "";

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            
            for (const folderName of selectedFolders) {
                
                
                const response = await fetch(`${serverUrl}/api/fs/remove`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        names: [folderName],
                        dir: currentPath
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`${t('messages.failedToDeleteFolders')}: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.code !== 200) {
                    throw new Error(result.message || t('messages.failedToDeleteFolders'));
                }
            }
            
            // Âà∑Êñ∞Êñá‰ª∂ÂàóË°®ÔºàÂº∫Âà∂Âà∑Êñ∞‰ª•Á°Æ‰øùÂà†Èô§ÁöÑÊñá‰ª∂Â§π‰∏çÂÜçÊòæÁ§∫Ôºâ
            await loadFiles(currentPath, true);
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            await pushMsg(t('messages.foldersDeletedSuccess', {count: selectedFolders.size}));
            selectedFolders.clear();
            
        } catch (err) {
            console.error("Delete folders failed:", err);
            error = `${t('messages.failedToDeleteFolders')}: ${err.message || t('errors.unknownError')}`;
        } finally {
            isDeletingFolders = false;
        }
    }

    /**
     * ÂàáÊç¢Êñá‰ª∂ÈÄâÊã©Áä∂ÊÄÅ
     */
    function toggleFileSelection(fileName) {
        if (selectedFiles.has(fileName)) {
            selectedFiles.delete(fileName);
        } else {
            selectedFiles.add(fileName);
        }
        selectedFiles = selectedFiles; // Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞
    }

    /**
     * Âà†Èô§ÈÄâ‰∏≠ÁöÑÊñá‰ª∂
     */
    /**
     * ÈáçÂëΩÂêçÈÄâ‰∏≠ÁöÑÊñá‰ª∂
     */
    async function renameSelectedFile() {
        if (selectedFiles.size === 0) {
            error = t('errors.selectFileToRename');
            return;
        }

        if (selectedFiles.size > 1) {
            error = t('errors.renameOnlyOneFile');
            return;
        }

        const fileName = Array.from(selectedFiles)[0];
        
        // ‰ΩøÁî®inputDialogÊõøÊç¢prompt
        
        inputDialog({
            title: "Rename File",
            placeholder: t('errors.newFileName'),
            defaultText: fileName,
            confirm: async (newName) => {
                 const newFileName = newName as string;
                 if (!newFileName || newFileName === fileName) {
                     return;
                 }
                 
                 if (!newFileName.trim()) {
                     error = t('errors.fileNameRequired');
                     return;
                 }

                 isDeletingFiles = true; // Â§çÁî®Âà†Èô§Áä∂ÊÄÅÂèòÈáè
                 error = "";

                 try {
                     const serverUrl = plugin.settingUtils.get("serverUrl");
                     const oldPath = currentPath === "/" ? `/${fileName}` : `${currentPath}/${fileName}`;
                     
                     const response = await fetch(`${serverUrl}/api/fs/rename`, {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json',
                             'Authorization': token
                         },
                         body: JSON.stringify({
                             name: newFileName.trim(),
                             path: oldPath
                         })
                     });
                     
                     if (!response.ok) {
                         throw new Error(`${t('messages.failedToRenameFile')}: ${response.status}`);
                     }
                     
                     const result = await response.json();
                     if (result.code !== 200) {
                         throw new Error(result.message || t('messages.failedToRenameFile'));
                     }
                     
                     // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                     await pushMsg(t('messages.fileRenamedSuccess', {oldName: fileName, newName: newFileName.trim()}));
                     
                     // ‰ΩøÁî®Êñ∞ÁöÑÂà∑Êñ∞ÂáΩÊï∞ÔºåÁ°Æ‰øùÂÆåÂÖ®ÈáçÊñ∞Ê∏≤Êüì
                     await refreshFileList();
                    
                } catch (err) {
                    console.error("Rename file failed:", err);
                    error = `${t('messages.failedToRenameFile')}: ${err.message || t('errors.unknownError')}`;
                } finally {
                    isDeletingFiles = false;
                }
            },
            cancel: () => {
                // Áî®Êà∑ÂèñÊ∂àÊìç‰Ωú
            }
        });
    }

    /**
     * ÁßªÂä®ÈÄâ‰∏≠ÁöÑÊñá‰ª∂ÊàñÊñá‰ª∂Â§π
     */
    async function moveSelectedItem() {
        if (selectedFiles.size === 0) {
            error = t('errors.selectItemToMove');
            return;
        }

        if (selectedFiles.size > 1) {
            error = t('errors.moveOnlyOneItem');
            return;
        }

        const itemName = Array.from(selectedFiles)[0];
        moveItem = itemName;
        
        // Âä†ËΩΩÊñá‰ª∂Â§πÊ†ë
        await loadFolderTree();
        
        // ÊòæÁ§∫ÁßªÂä®ÂØπËØùÊ°Ü
        showMoveDialog = true;
    }

    /**
     * Âä†ËΩΩÊñá‰ª∂Â§πÊ†ëÔºàÊ†πÁõÆÂΩïÔºâ
     */
    async function loadFolderTree() {
        if (!isLoggedIn || !token) {
            error = t('errors.loginRequired');
            return;
        }

        isLoadingFolderTree = true;
        error = "";
        expandedFolders.clear();
        loadingSubfolders.clear();

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            
            const response = await fetch(`${serverUrl}/api/fs/dirs`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({
                    path: "/",
                    password: ""
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            if (data.code !== 200) {
                throw new Error(data.message || t('errors.failedToGetFolderList'));
            }
            
            // ‰∏∫ÊØè‰∏™Êñá‰ª∂Â§πÊ∑ªÂä†Ê†ëÂΩ¢ÁªìÊûÑÊâÄÈúÄÁöÑÂ±ûÊÄß
            folderTree = (data.data || []).map(folder => ({
                ...folder,
                path: folder.path || `/${folder.name}`,
                children: [],
                isExpanded: false,
                hasChildren: true // ÂÅáËÆæÊâÄÊúâÊñá‰ª∂Â§πÈÉΩÂèØËÉΩÊúâÂ≠êÊñá‰ª∂Â§π
            }));
        } catch (err) {
            console.error("Load folder tree failed:", err);
            error = `${t('messages.failedToLoadFolderTree')}: ${err.message || t('errors.unknownError')}`;
        } finally {
            isLoadingFolderTree = false;
        }
    }

    /**
     * Âä†ËΩΩÊåáÂÆöË∑ØÂæÑÁöÑÂ≠êÊñá‰ª∂Â§π
     */
    async function loadSubfolders(folderPath) {
        if (!isLoggedIn || !token) {
            return;
        }

        loadingSubfolders.add(folderPath);
        loadingSubfolders = loadingSubfolders; // Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            
            const response = await fetch(`${serverUrl}/api/fs/dirs`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({
                    path: folderPath,
                    password: ""
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            if (data.code !== 200) {
                throw new Error(data.message || t('errors.failedToGetSubfolders'));
            }
            
            // Êõ¥Êñ∞Êñá‰ª∂Â§πÊ†ë‰∏≠ÂØπÂ∫îËäÇÁÇπÁöÑÂ≠êÊñá‰ª∂Â§π
            updateFolderChildren(folderTree, folderPath, data.data || []);
            folderTree = folderTree; // Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞
            
        } catch (err) {
            console.error("Load subfolders failed:", err);
            error = `${t('messages.failedToLoadSubfolders')}: ${err.message || t('errors.unknownError')}`;
        } finally {
            loadingSubfolders.delete(folderPath);
            loadingSubfolders = loadingSubfolders; // Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞
        }
    }

    /**
     * ÈÄíÂΩíÊõ¥Êñ∞Êñá‰ª∂Â§πÊ†ë‰∏≠ÊåáÂÆöË∑ØÂæÑÁöÑÂ≠êÊñá‰ª∂Â§π
     */
    function updateFolderChildren(tree, targetPath, children) {
        for (let folder of tree) {
            if (folder.path === targetPath) {
                folder.children = children.map(child => ({
                    ...child,
                    path: child.path || `${targetPath}/${child.name}`.replace('//', '/'),
                    children: [],
                    isExpanded: false,
                    hasChildren: true
                }));
                folder.isExpanded = true;
                return true;
            }
            if (folder.children && folder.children.length > 0) {
                if (updateFolderChildren(folder.children, targetPath, children)) {
                    return true;
                }
            }
        }
        return false;
    }

    /**
     * ÂàáÊç¢Êñá‰ª∂Â§πÂ±ïÂºÄ/ÊäòÂè†Áä∂ÊÄÅ
     */
    async function toggleFolder(folder) {
        if (folder.isExpanded) {
            // ÊäòÂè†Êñá‰ª∂Â§π
            folder.isExpanded = false;
            expandedFolders.delete(folder.path);
        } else {
            // Â±ïÂºÄÊñá‰ª∂Â§π
            if (folder.children.length === 0) {
                // È¶ñÊ¨°Â±ïÂºÄÔºåÈúÄË¶ÅÂä†ËΩΩÂ≠êÊñá‰ª∂Â§π
                await loadSubfolders(folder.path);
            } else {
                // Â∑≤ÊúâÂ≠êÊñá‰ª∂Â§πÊï∞ÊçÆÔºåÁõ¥Êé•Â±ïÂºÄ
                folder.isExpanded = true;
                expandedFolders.add(folder.path);
            }
        }
        folderTree = folderTree; // Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞
    }

    /**
     * ÈÄíÂΩíÊ∏≤ÊüìÊñá‰ª∂Â§πÊ†ë
     */
    function renderFolderTree(folderData, level, isLast = false, prefix = '') {
        const items = [];
        const currentPrefix = level === 0 ? '' : prefix + (isLast ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ');
        items.push({ folder: folderData, level, prefix: currentPrefix, isLast });
        if (folderData.isExpanded && folderData.children) {
            const childPrefix = level === 0 ? '' : prefix + (isLast ? '    ' : '‚îÇ   ');
            for (let i = 0; i < folderData.children.length; i++) {
                const child = folderData.children[i];
                const childIsLast = i === folderData.children.length - 1;
                items.push(...renderFolderTree(child, level + 1, childIsLast, childPrefix));
            }
        }
        return items;
    }

    /**
     * ÈáçÊñ∞Âä†ËΩΩÊñá‰ª∂ÂàóË°®
     * Áõ¥Êé•Ë∞ÉÁî® API ÈáçÊñ∞Ëé∑ÂèñÊúÄÊñ∞ÁöÑÊñá‰ª∂ÂàóË°®
     */
    async function refreshFileList() {
        // Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
        selectedFiles.clear();
        selectedFiles = selectedFiles; // Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞
        
        // Áõ¥Êé•Ë∞ÉÁî® API ÈáçÊñ∞Ëé∑ÂèñÊñá‰ª∂ÂàóË°®
        await loadFiles(currentPath, true);
    }

    /**
     * ÊâßË°åÁßªÂä®Êìç‰Ωú
     */
    async function executeMove() {
        if (!moveItem || !moveTargetPath) {
            error = t('functionGroup.pleaseSelectTargetFolder');
            return;
        }

        isMoving = true;
        error = "";

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            
            // Ê£ÄÊü•ÊòØÊñá‰ª∂ËøòÊòØÊñá‰ª∂Â§π
            const file = files.find(f => f.name === moveItem);
            const isFolder = file && file.is_dir;
            
            const apiEndpoint = isFolder ? '/api/fs/move_dir' : '/api/fs/move';
            
            const requestBody: any = {
                src_dir: currentPath,
                dst_dir: moveTargetPath,
                names: [moveItem]
            };
            
            // Â¶ÇÊûúÂÖÅËÆ∏Ë¶ÜÁõñÔºåÊ∑ªÂä†overwriteÂèÇÊï∞
            if (allowOverwrite) {
                requestBody.overwrite = true;
            }
            
            const response = await fetch(`${serverUrl}${apiEndpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            // Ê†πÊçÆAPIËøîÂõûÁöÑmessageÂà§Êñ≠ÊòØÂê¶ÊàêÂäü
            if (result.message === 'success' || result.code === 200) {
                // ÁßªÂä®ÊàêÂäü
                await pushMsg(`${isFolder ? 'Folder' : 'File'} moved successfully: ${moveItem} ‚Üí ${moveTargetPath}`);
                
                // ‰ΩøÁî®Êñ∞ÁöÑÂà∑Êñ∞ÂáΩÊï∞ÔºåÁ°Æ‰øùÂÆåÂÖ®ÈáçÊñ∞Ê∏≤Êüì
                await refreshFileList();
                
                // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
                closeMoveDialog();
            } else {
                throw new Error(result.message || t('errors.moveOperationFailed'));
            }
            
        } catch (err) {
            console.error("Move item failed:", err);
            error = `Move failed: ${err.message || t('errors.unknownError')}`;
        } finally {
            isMoving = false;
        }
    }

    /**
     * ÁßªÂä®ÈÄâ‰∏≠ÁöÑÊñá‰ª∂Â§π
     */
    async function moveSelectedFolder() {
        if (selectedFolders.size === 0) {
            error = t('errors.selectFolderToMove');
            return;
        }

        if (selectedFolders.size > 1) {
            error = t('errors.moveOnlyOneFolder');
            return;
        }

        const folderName = Array.from(selectedFolders)[0];
        moveItem = folderName;
        
        // Âä†ËΩΩÊñá‰ª∂Â§πÊ†ë
        await loadFolderTree();
        
        // ÊòæÁ§∫ÁßªÂä®ÂØπËØùÊ°Ü
        showMoveDialog = true;
    }

    /**
     * ÂÖ≥Èó≠ÁßªÂä®ÂØπËØùÊ°Ü
     */
    function closeMoveDialog() {
        showMoveDialog = false;
        moveTargetPath = "/";
        moveItem = null;
        allowOverwrite = false;
        folderTree = [];
    }

    async function deleteSelectedFiles() {
        if (selectedFiles.size === 0) {
            error = t('errors.selectFilesToDelete');
            return;
        }

        if (!confirm(`Are you sure you want to delete the selected ${selectedFiles.size} files? This operation cannot be undone!`)) {
            return;
        }

        isDeletingFiles = true;
        error = "";

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            
            for (const fileName of selectedFiles) {
                const response = await fetch(`${serverUrl}/api/fs/remove`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        names: [fileName],
                        dir: currentPath
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to delete file ${fileName}: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.code !== 200) {
                    throw new Error(result.message || `Failed to delete file ${fileName}`);
                }
            }
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            await pushMsg(`Successfully deleted ${selectedFiles.size} files!`);
            
            // ‰ΩøÁî®Êñ∞ÁöÑÂà∑Êñ∞ÂáΩÊï∞ÔºåÁ°Æ‰øùÂÆåÂÖ®ÈáçÊñ∞Ê∏≤Êüì
            await refreshFileList();
            
        } catch (err) {
            console.error("Delete files failed:", err);
            error = `Failed to delete files: ${err.message || t('errors.unknownError')}`;
        } finally {
            isDeletingFiles = false;
        }
    }

    /**
     * Ëé∑ÂèñÊú™ÂÆåÊàê‰ªªÂä°ÂàóË°®
     */
    async function loadUndoneTasks() {
        if (!isLoggedIn || !token) {
            error = "Please login first";
            return;
        }

        isLoadingTasks = true;
        error = "";

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            
            // Ëé∑ÂèñÊú™ÂÆåÊàêÁöÑ‰ªªÂä°
            const undoneResponse = await fetch(`${serverUrl}/api/admin/task/upload/undone`, {
                method: 'GET',
                headers: {
                    'Authorization': token
                }
            });

            if (!undoneResponse.ok) {
                throw new Error(`HTTP ${undoneResponse.status}: ${undoneResponse.statusText}`);
            }

            const undoneData = await undoneResponse.json();
            if (undoneData.code !== 200) {
                throw new Error(undoneData.message || t('errors.failedToGetUndoneTasks'));
            }

            // Ëé∑ÂèñÂ∑≤ÂÆåÊàêÁöÑÁ¶ªÁ∫ø‰∏ãËΩΩ‰ªªÂä°ÔºàÂåÖÊã¨Â§±Ë¥•ÁöÑÔºâ
            const doneResponse = await fetch(`${serverUrl}/api/task/offline_download/done`, {
                method: 'GET',
                headers: {
                    'Authorization': token
                }
            });

            let doneTasks = [];
            if (doneResponse.ok) {
                const doneData = await doneResponse.json();
                if (doneData.code === 200) {
                    // ÊòæÁ§∫ÊâÄÊúâÂ∑≤ÂÆåÊàêÁöÑ‰ªªÂä°ÔºàÊàêÂäüÔºöstate=2ÔºåÂ§±Ë¥•Ôºöstate=7Ôºâ
                    doneTasks = (doneData.data || []).filter(task => task.state === 2 || task.state === 7);
                }
            }

            // ÂêàÂπ∂Êú™ÂÆåÊàê‰ªªÂä°ÂíåÂ∑≤ÂÆåÊàê‰ªªÂä°
            tasks = [...(undoneData.data || []), ...doneTasks];
        } catch (err) {
            console.error("Load tasks failed:", err);
            error = `${t('messages.failedToLoadTasks')}: ${err.message || t('errors.unknownError')}`;
        } finally {
            isLoadingTasks = false;
        }
    }

    /**
     * Á¶ªÁ∫ø‰∏ãËΩΩÊñá‰ª∂
     */
    async function startOfflineDownload() {
        if (!downloadUrls.trim()) {
            error = t('errors.enterDownloadLinks');
            return;
        }

        isOfflineDownloading = true;
        error = "";

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            const urls = downloadUrls.split('\n').filter(url => url.trim());
            
            for (const url of urls) {
                const response = await fetch(`${serverUrl}/api/fs/add_offline_download`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        path: currentPath,
                        urls: [url.trim()],
                        tool: "SimpleHttp",
                        delete_policy: "delete_on_upload_succeed"
                    })
                });

                if (!response.ok) {
                throw new Error(`${t('messages.failedToAddOfflineDownload')}: ${response.status} ${response.statusText}`);
            }

                const result = await response.json();
                if (result.code !== 200) {
                    throw new Error(result.message || t('errors.failedToAddOfflineDownload'));
                }
            }

            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            await pushMsg(`Successfully added ${urls.length} offline download tasks!`);
            downloadUrls = "";
            
        } catch (err) {
            console.error("Offline download failed:", err);
            error = `${t('errors.offlineDownloadFailed')}: ${err.message || t('errors.unknownError')}`;
        } finally {
            isOfflineDownloading = false;
        }
    }



    /**
     * Ê†ºÂºèÂåñ‰ªªÂä°ÂêçÁß∞ÔºåÁßªÈô§"download "ÂâçÁºÄÂπ∂‰ºòÂåñÊòæÁ§∫
     */
    /**
     * Ê†ºÂºèÂåñ‰ªªÂä°ÂêçÁß∞ÊòæÁ§∫
     * @param {string} name - ÂéüÂßã‰ªªÂä°ÂêçÁß∞
     * @returns {string} Ê†ºÂºèÂåñÂêéÁöÑ‰ªªÂä°ÂêçÁß∞
     */
    function formatTaskName(name) {
        if (!name) return t('errors.unknownTask');
        
        // ÁßªÈô§"download "ÂâçÁºÄ
        let cleanName = name.replace(/^download\s+/, '');
        
        // ÁßªÈô§" to ("‰πãÂêéÁöÑÂ≠òÂÇ®Ë∑ØÂæÑÈÉ®ÂàÜ
        const toIndex = cleanName.indexOf(' to (');
        if (toIndex !== -1) {
            cleanName = cleanName.substring(0, toIndex);
        }
        
        // Â∞ùËØï‰ªé‰ªªÂä°ÂêçÁß∞‰∏≠ÊèêÂèñURLÔºàÂ§ÑÁêÜÂèçÂºïÂè∑ÂåÖÂõ¥ÁöÑURLÔºâ
        const match = cleanName.match(/`(.+?)`/);
        if (match) {
            const url = match[1];
            try {
                const urlObj = new URL(url);
                const domain = urlObj.hostname;
                // Ëé∑ÂèñURLË∑ØÂæÑÁöÑÊúÄÂêéÈÉ®ÂàÜ‰Ωú‰∏∫Êñá‰ª∂Âêç
                const pathParts = urlObj.pathname.split('/');
                const fileName = pathParts[pathParts.length - 1] || 'index';
                return `${domain}/${fileName}`;
            } catch {
                // Â¶ÇÊûú‰∏çÊòØÊúâÊïàURLÔºåÊòæÁ§∫ÂéüÂßãURLÁöÑÂÖ≥ÈîÆÈÉ®ÂàÜ
                return url.length > 50 ? `${url.slice(0, 25)}...${url.slice(-20)}` : url;
            }
        }
        
        // ÂØπ‰∫éÂÖ∂‰ªñÁ±ªÂûãÁöÑ‰ªªÂä°ÂêçÁß∞ÔºåÁõ¥Êé•ÊòæÁ§∫Ê∏ÖÁêÜÂêéÁöÑÂêçÁß∞
        return cleanName.length > 60 ? `${cleanName.slice(0, 30)}...${cleanName.slice(-25)}` : cleanName;
    }

    // ‰ªªÂä°ÈÄâÊã©Áä∂ÊÄÅ
    let selectedTasks = new Set();

    /**
     * ÂàáÊç¢‰ªªÂä°ÈÄâÊã©Áä∂ÊÄÅ
     */
    function toggleTaskSelection(taskId) {
        if (selectedTasks.has(taskId)) {
            selectedTasks.delete(taskId);
        } else {
            selectedTasks.add(taskId);
        }
        selectedTasks = selectedTasks; // Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞
    }

    /**
     * ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ‰ªªÂä°
     */
    function toggleAllTasks() {
        if (selectedTasks.size === tasks.length) {
            selectedTasks.clear();
        } else {
            selectedTasks = new Set(tasks.map(task => task.id || task.name));
        }
        selectedTasks = selectedTasks; // Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞
    }

    /**
     * Ê∏ÖÁ©∫Â∑≤ÊàêÂäüÁöÑÁ¶ªÁ∫ø‰∏ãËΩΩ‰ªªÂä°
     * Ë∞ÉÁî®APIÊ∏ÖÈô§ÊâÄÊúâÂ∑≤ÂÆåÊàêÁä∂ÊÄÅÁöÑ‰ªªÂä°
     */
    async function clearSucceededTasks() {
        if (!token) {
            error = "Please login first";
            return;
        }

        isLoading = true;
        error = "";

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            
            const response = await fetch(`${serverUrl}/api/task/offline_download/clear_succeeded`, {
                method: 'POST',
                headers: {
                    'Authorization': token,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            if (result.code !== 200) {
                throw new Error(result.message || t('errors.failedToClearSucceededTasks'));
            }

            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            await pushMsg('All successful offline download tasks cleared!');
            
            // Âà∑Êñ∞‰ªªÂä°ÂàóË°®
            await loadUndoneTasks();
            
        } catch (err) {
            console.error("Clear succeeded tasks error:", err);
            error = `${t('messages.failedToClearSucceededTasks')}: ${err.message || t('errors.unknownError')}`;
        } finally {
            isLoading = false;
        }
    }

    /**
     * ÈáçËØïÂ∑≤ÈÄâ‰∏≠ÁöÑÁ¶ªÁ∫ø‰∏ãËΩΩ‰ªªÂä°
     * Ë∞ÉÁî®APIÈáçËØïÊåáÂÆöÁöÑ‰ªªÂä°IDÂàóË°®
     */
    async function retrySelectedTasks() {
        if (!token) {
            error = "Please login first";
            return;
        }

        // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÁöÑ‰ªªÂä°
        if (selectedTasks.size === 0) {
            await pushMsg('Please select tasks to retry first!');
            return;
        }

        isLoading = true;
        error = "";

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            const taskIds = Array.from(selectedTasks);
            
            const response = await fetch(`${serverUrl}/api/task/offline_download/retry_some`, {
                method: 'POST',
                headers: {
                    'Authorization': token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskIds)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            if (result.code !== 200) {
                throw new Error(result.message || t('errors.failedToRetrySelectedTasks'));
            }

            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            await pushMsg(`Retried ${taskIds.length} selected offline download tasks!`);
            
            // Ê∏ÖÁ©∫ÈÄâ‰∏≠Áä∂ÊÄÅ
            selectedTasks.clear();
            selectedTasks = selectedTasks;
            
            // Âà∑Êñ∞‰ªªÂä°ÂàóË°®
            await loadUndoneTasks();
            
        } catch (err) {
            console.error("Retry selected tasks error:", err);
            error = `${t('messages.failedToRetrySelectedTasks')}: ${err.message || t('errors.unknownError')}`;
        } finally {
            isLoading = false;
        }
    }

    /**
     * Ê∏ÖÁ©∫Â∑≤ÂÆåÊàêÁöÑÁ¶ªÁ∫ø‰∏ãËΩΩ‰ªªÂä°
     * Ë∞ÉÁî®APIÊ∏ÖÈô§ÊâÄÊúâÂ∑≤ÂÆåÊàêÁä∂ÊÄÅÁöÑ‰ªªÂä°
     */
    async function clearDoneTasks() {
        if (!token) {
            error = "Please login first";
            return;
        }

        isLoading = true;
        error = "";

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            
            const response = await fetch(`${serverUrl}/api/task/offline_download/clear_done`, {
                method: 'POST',
                headers: {
                    'Authorization': token,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            if (result.code !== 200) {
                throw new Error(result.message || t('errors.failedToClearDoneTasks'));
            }

            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            await pushMsg('All completed offline download tasks cleared!');
            
            // Âà∑Êñ∞‰ªªÂä°ÂàóË°®
            await loadUndoneTasks();
            
        } catch (err) {
            console.error("Clear done tasks error:", err);
            error = `${t('messages.failedToClearDoneTasks')}: ${err.message || t('errors.unknownError')}`;
        } finally {
            isLoading = false;
        }
    }

    /**
     * ÈáçËØïÂ§±Ë¥•ÁöÑÁ¶ªÁ∫ø‰∏ãËΩΩ‰ªªÂä°
     */
    async function retryFailedTasks() {
        if (!token) {
            error = "Please login first";
            return;
        }

        isLoading = true;
        error = "";

        try {
            const serverUrl = plugin.settingUtils.get("serverUrl");
            
            const response = await fetch(`${serverUrl}/api/task/offline_download/retry_failed`, {
                method: 'POST',
                headers: {
                    'Authorization': token,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            if (result.code !== 200) {
                throw new Error(result.message || t('errors.failedToRetryFailedTasks'));
            }

            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            await pushMsg('All failed offline download tasks retried!');
            
            // Âà∑Êñ∞‰ªªÂä°ÂàóË°®
            await loadUndoneTasks();
            
        } catch (err) {
            console.error("Retry failed tasks error:", err);
            error = `${t('messages.failedToRetryFailedTasks')}: ${err.message || t('errors.unknownError')}`;
        } finally {
            isLoading = false;
        }
    }


</script>

<div class="alist-browser">
    <!-- Â§¥ÈÉ®Â∑•ÂÖ∑Ê†è -->
    <div class="alist-header">
        <div class="alist-path">
            <button class="b3-button b3-button--small" on:click={goBack} disabled={currentPath === "/" || isLoading}>
                ‚¨ÖÔ∏è {t('back')}
            </button>
            <span class="alist-current-path">{currentPath}</span>
        </div>
        <div class="alist-actions">
            {#if !isLoggedIn}
                <button class="b3-button b3-button--small" on:click={loginAndLoadFiles} disabled={isLoading}>
                    üîë {t('login')}
                </button>
            {:else}
                <button class="b3-button b3-button--small" on:click={showFunctionGroupDialog} disabled={isLoading}>
                    ‚öôÔ∏è {t('functions')}
                </button>
                <button class="b3-button b3-button--small" on:click={refreshFileList} disabled={isLoading}>
                    üîÑ {t('refresh')}
                </button>
            {/if}
        </div>
    </div>

    <!-- ÂÜÖÂÆπÂå∫Âüü -->
    <div class="alist-content">
        {#if isLoading}
            <div class="alist-loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">
                    <span class="loading-title">{t('loading')}</span>
                    <span class="loading-subtitle">
                        {#if !isLoggedIn}
                            {t('connectingToServer')}
                        {:else}
                            {t('gettingFileList')}
                        {/if}
                    </span>
                </div>
            </div>
        {:else if error}
            <div class="alist-error">
                <div class="error-icon">‚ö†Ô∏è</div>
                <div class="error-message">{error}</div>
                <button class="b3-button b3-button--small" on:click={loginAndLoadFiles}>
                    {t('retry')}
                </button>
            </div>
        {:else if !isLoggedIn}
            <div class="alist-welcome">
                <div class="welcome-icon">üìÅ</div>
                <h3>{t('alistFileBrowser')}</h3>
                <p>{t('errors.configRequired')}</p>
                <button class="b3-button" on:click={loginAndLoadFiles}>
                    üîë {t('loginNow')}
                </button>
            </div>
        {:else if files.length === 0}
            <div class="alist-empty">
                <div class="empty-icon">üìÇ</div>
                <p>{t('directoryEmpty')}</p>
            </div>
        {:else}
            <div class="alist-file-list">
                {#each files as file}
                    <div class="alist-file-item" class:is-directory={file.is_dir}>
                        {#if file.is_dir && selectedFolders.size > 0}
                            <div class="folder-checkbox">
                                <input 
                                    type="checkbox" 
                                    checked={selectedFolders.has(file.name)}
                                    on:change={() => toggleFolderSelection(file.name)}
                                />
                            </div>
                        {/if}
                        <div class="file-icon">{getFileIcon(file)}</div>
                        <div class="file-info">
                            <div class="file-name" 
                                 on:click={() => file.is_dir ? enterFolder(file.name) : null}
                                 class:clickable={file.is_dir}>
                                {file.name}
                            </div>
                            <div class="file-meta">
                                {#if !file.is_dir}
                                    <span class="file-size">{formatFileSize(file.size)}</span>
                                {/if}
                                <span class="file-date">{formatDate(file.modified)}</span>
                            </div>
                        </div>
                        {#if !file.is_dir}
                            <div class="file-actions">
                                <button 
                                    class="b3-button b3-button--small preview-btn" 
                                    on:click={() => showFilePreview(file)}
                                    title="Preview file"
                                >
                                    üëÅÔ∏è {t('preview')}
                                </button>
                                <button 
                                    class="b3-button b3-button--small download-btn"
                                    on:click={() => downloadFile(file)}
                                    title="Download file"
                                    style="margin-left: 4px;"
                                >
                                    üì• {t('download')}
                                </button>
                                <button 
                                    class="b3-button b3-button--small embed-link-btn"
                                    on:click={() => embedAListLink(file)}
                                    title="Embed to note"
                                    style="margin-left: 4px;"
                                >
                                    üìù {t('embedHere')}
                                </button>
                            </div>
                        {/if}
                    </div>
                {/each}
            </div>
        {/if}
    </div>

    <!-- ‰∏ä‰º†ÂØπËØùÊ°Ü -->
    {#if showUpload}
        <div class="upload-overlay" on:click={closeUploadDialog}>
            <div class="upload-dialog" on:click|stopPropagation>
                <div class="upload-header">
                    <h3>üì§ {t('upload.title', { path: currentPath })}</h3>
                    <button class="close-btn" on:click={closeUploadDialog}>‚úï</button>
                </div>
                
                <div class="upload-body">
                    <!-- Êñá‰ª∂ÈÄâÊã©Âå∫Âüü -->
                    <div class="upload-drop-zone">
                        <input 
                            type="file" 
                            multiple 
                            id="file-input" 
                            style="display: none;" 
                            on:change={handleFileSelect}
                        />
                        <input 
                            type="file" 
                            multiple 
                            id="folder-input" 
                            style="display: none;" 
                            on:change={handleFolderSelect}
                        />
                        
                        <h4>{t('upload.dragHint')}</h4>
                        
                        <!-- Êñá‰ª∂ÈÄâÊã©ÊåâÈíÆ -->
                        <div class="upload-buttons">
                            <button 
                                class="upload-btn folder-btn" 
                                on:click={() => document.getElementById('folder-input').click()}
                                title={t('upload.selectFolder')}
                            >
                                üìÅ
                            </button>
                            <button 
                                class="upload-btn file-btn" 
                                on:click={() => document.getElementById('file-input').click()}
                                title={t('upload.selectFiles')}
                            >
                                üìÑ
                            </button>
                        </div>
                        
                        <!-- ‰∏ä‰º†ÈÖçÁΩÆË°å -->
                        <div class="upload-config-row">
                            <!-- ‰∏ä‰º†Ê®°ÂºèÈÄâÊã© -->
                            <div class="upload-mode">
                                <label for="upload-mode-select">{t('upload.mode')}:</label>
                                <select id="upload-mode-select" bind:value={uploadMode} class="b3-select">
                                    <option value="stream">{t('upload.streamMode')}</option>
                                    <option value="form">{t('upload.formMode')}</option>
                                </select>
                            </div>
                            
                            <!-- ‰∏ä‰º†ÈÄâÈ°π -->
                            <div class="upload-options">
                                <label class="upload-checkbox">
                                    <input type="checkbox" bind:checked={addAsTask} />
                                    <span>{t('upload.addAsTask')}</span>
                                </label>
                                <label class="upload-checkbox">
                                    <input type="checkbox" bind:checked={overwriteExisting} />
                                    <span>{t('upload.overwriteExisting')}</span>
                                </label>
                                <label class="upload-checkbox">
                                    <input type="checkbox" bind:checked={tryInstantUpload} />
                                    <span>{t('upload.tryInstant')}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÈÄâ‰∏≠ÁöÑÊñá‰ª∂ÂàóË°® -->
                    {#if uploadFiles.length > 0}
                        <div class="selected-files">
                            <h4>{t('upload.selectedFiles', { count: uploadFiles.length })}:</h4>
                            <div class="file-list">
                                {#each uploadFiles as file, index}
                                    <div class="selected-file">
                                        <span class="file-name">{file.webkitRelativePath || file.name}</span>
                                        <span class="file-size">({formatFileSize(file.size)})</span>
                                        <button class="remove-btn" on:click={() => removeFile(index)}>‚úï</button>
                                    </div>
                                {/each}
                            </div>
                        </div>
                    {/if}
                    
                    <!-- ‰∏ä‰º†ËøõÂ∫¶ -->
                    {#if isUploading}
                        <div class="upload-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {uploadProgress}%"></div>
                            </div>
                            <span class="progress-text">{uploadProgress}%</span>
                        </div>
                    {/if}
                    
                    <!-- ÈîôËØØ‰ø°ÊÅØ -->
                    {#if error}
                        <div class="upload-error">{error}</div>
                    {/if}
                </div>
                
                <div class="upload-footer">
                    <button class="b3-button" on:click={closeUploadDialog} disabled={isUploading}>
                        {t('upload.cancel')}
                    </button>
                    <button 
                        class="b3-button b3-button--primary" 
                        on:click={uploadFilesToAList} 
                        disabled={uploadFiles.length === 0 || isUploading}
                    >
                        {#if isUploading}
                            {t('upload.uploading')}
                        {:else}
                            {t('upload.startUpload')}
                        {/if}
                    </button>
                </div>
            </div>
        </div>
    {/if}

    <!-- ÂäüËÉΩÁªÑÂØπËØùÊ°Ü -->
    {#if showFunctionGroup}
        <div class="function-overlay" on:click={closeFunctionGroupDialog}>
            <div class="function-dialog" on:click|stopPropagation>
                <div class="function-header">
                    <h3>‚öôÔ∏è {t('functionGroup.title')}</h3>
                    <button class="close-btn" on:click={closeFunctionGroupDialog}>‚úï</button>
                </div>
                
                <div class="function-tabs">
                    <button 
                        class="tab-btn" 
                        class:active={activeTab === "folder"}
                        on:click={() => switchTab("folder")}
                    >
                        {t('functionGroup.folderManagement')}
                    </button>
                    <button 
                        class="tab-btn" 
                        class:active={activeTab === "file"}
                        on:click={() => switchTab("file")}
                    >
                        {t('functionGroup.fileManagement')}
                    </button>
                    <button 
                        class="tab-btn" 
                        class:active={activeTab === "upload"}
                        on:click={() => switchTab("upload")}
                    >
                        {t('functionGroup.uploadFiles')}
                    </button>
                    <button 
                        class="tab-btn" 
                        class:active={activeTab === "task"}
                        on:click={() => switchTab("task")}
                    >
                        {t('functionGroup.taskList')}
                    </button>
                </div>
                
                <div class="function-body">
                    {#if activeTab === "folder"}
                        <div class="folder-management">
                            <!-- Êñ∞Âª∫Êñá‰ª∂Â§π -->
                            <div class="function-section">
                                <h4>{t('functionGroup.createNewFolder')}</h4>
                                <div class="input-group">
                                    <input 
                                        type="text" 
                                        bind:value={newFolderName}
                                        placeholder={t('functionGroup.enterFolderName')}
                                        class="b3-text-field"
                                        disabled={isCreatingFolder}
                                        on:keydown={(e) => e.key === 'Enter' && createFolder()}
                                    />
                                    <button 
                                        class="b3-button b3-button--primary"
                                        on:click={createFolder}
                                        disabled={isCreatingFolder || !newFolderName.trim()}
                                    >
                                        {#if isCreatingFolder}
                                            {t('functionGroup.creating')}
                                        {:else}
                                            {t('functionGroup.create')}
                                        {/if}
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Âà†Èô§Êñá‰ª∂Â§π -->
                            <div class="function-section">
                                <h4>{t('functionGroup.deleteFolder')}</h4>
                                <p class="section-desc">{t('functionGroup.selectFoldersToDelete')}</p>
                                
                                <div class="folder-selection">
                                    {#if files.filter(f => f.is_dir).length === 0}
                                        <p class="no-folders">{t('functionGroup.noFoldersInDirectory')}</p>
                                    {:else}
                                        <div class="folder-list">
                                            {#each files.filter(f => f.is_dir) as folder}
                                                <label class="folder-item">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={selectedFolders.has(folder.name)}
                                                        on:change={() => toggleFolderSelection(folder.name)}
                                                    />
                                                    <span class="folder-name">üìÅ {folder.name}</span>
                                                </label>
                                            {/each}
                                        </div>
                                        
                                        {#if selectedFolders.size > 0}
                                            <div class="delete-actions">
                                                <p class="selected-count">{t('functionGroup.selectedFolders', {count: selectedFolders.size})}</p>
                                                <div class="folder-action-buttons">
                                                    <button 
                                                        class="b3-button b3-button--danger"
                                                        on:click={deleteSelectedFolders}
                                                        disabled={isDeletingFolders}
                                                        style="margin-right: 8px;"
                                                    >
                                                        {#if isDeletingFolders}
                                                            {t('functionGroup.deleting')}
                                                        {:else}
                                                            {t('functionGroup.deleteSelectedFolders')}
                                                        {/if}
                                                    </button>
                                                    <button 
                                                        class="b3-button"
                                                        on:click={moveSelectedFolder}
                                                        disabled={isDeletingFolders || selectedFolders.size !== 1}
                                                        style="background-color: #FF9800; color: white;"
                                                        title={selectedFolders.size > 1 ? t('functionGroup.moveOperationSingleFolder') : t('functionGroup.moveSelectedFolder')}
                                                    >
                                                        {t('functionGroup.move')}
                                                    </button>
                                                </div>
                                            </div>
                                        {/if}
                                    {/if}
                                </div>
                            </div>
                        </div>
                    {:else if activeTab === "file"}
                        <div class="file-management">
                            <div class="function-section">
                                
                                <div class="file-selection">
                                    {#if files.filter(f => !f.is_dir).length === 0}
                                        <p class="no-files">{t('functionGroup.noFilesInDirectory')}</p>
                                    {:else}
                                        <div class="file-list">
                                            {#each files.filter(f => !f.is_dir) as file}
                                                <label class="file-item">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={selectedFiles.has(file.name)}
                                                        on:change={() => toggleFileSelection(file.name)}
                                                    />
                                                    <span class="file-icon">{getFileIcon(file)}</span>
                                                    <span class="file-name">{file.name}</span>
                                                    <span class="file-size">({formatFileSize(file.size)})</span>
                                                </label>
                                            {/each}
                                        </div>
                                        
                                        {#if selectedFiles.size > 0}
                                            <div class="delete-actions">
                                                <p class="selected-count">{t('functionGroup.selectedFiles', {count: selectedFiles.size})}</p>
                                                <div class="file-action-buttons">
                                                    <button 
                                                        class="b3-button"
                                                        on:click={deleteSelectedFiles}
                                                        disabled={isDeletingFiles}
                                                        style="background-color: #f44336; color: white; margin-right: 8px;"
                                                    >
                                                        {#if isDeletingFiles}
                                                            {t('functionGroup.deleting')}
                                                        {:else}
                                                            {t('functionGroup.deleteSelected')}
                                                        {/if}
                                                    </button>
                                                    <button 
                                                        class="b3-button"
                                                        on:click={renameSelectedFile}
                                                        disabled={isDeletingFiles || selectedFiles.size !== 1}
                                                        style="background-color: #2196F3; color: white; margin-right: 8px;"
                                                        title={selectedFiles.size > 1 ? t('functionGroup.renameOperationSingleFile') : t('functionGroup.renameSelectedFile')}
                                                    >
                                                        {t('functionGroup.rename')}
                                                    </button>
                                                    <button 
                                                        class="b3-button"
                                                        on:click={moveSelectedItem}
                                                        disabled={isDeletingFiles || selectedFiles.size !== 1}
                                                        style="background-color: #FF9800; color: white;"
                                                        title={selectedFiles.size > 1 ? t('functionGroup.moveOperationSingleFile') : t('functionGroup.moveSelectedFile')}
                                                    >
                                                        {t('functionGroup.move')}
                                                    </button>
                                                </div>
                                            </div>
                                        {/if}
                                    {/if}
                                </div>
                            </div>
                        </div>
                    {:else if activeTab === "upload"}
                        <div class="upload-management">
                            <!-- ‰∏ä‰º†ÊñπÂºèÊ†áÁ≠æÈ°µ -->
                            <div class="upload-method-tabs">
                                <button 
                                    class="upload-method-tab" 
                                    class:active={uploadTab === "online"}
                                    on:click={() => uploadTab = "online"}
                                >
                                    üåê {t('functionGroup.onlineUpload')}
                                </button>
                                <button 
                                    class="upload-method-tab" 
                                    class:active={uploadTab === "offline"}
                                    on:click={() => uploadTab = "offline"}
                                >
                                    üì• {t('functionGroup.offlineDownload')}
                                </button>
                            </div>
                            
                            {#if uploadTab === "online"}
                                <!-- Âú®Á∫ø‰∏ä‰º†Âå∫Âüü -->
                                <div class="function-section">
                                    <h4>üì§ {t('functionGroup.onlineUploadTo', {path: currentPath})}</h4>
                                <div class="upload-drop-zone">
                                    <input 
                                        type="file" 
                                        multiple 
                                        id="function-file-input" 
                                        style="display: none;" 
                                        on:change={handleFileSelect}
                                    />
                                    <input 
                                        type="file" 
                                        multiple 
                                        id="function-folder-input" 
                                        style="display: none;" 
                                        on:change={handleFolderSelect}
                                    />
                                    
                                    <h5>{t('functionGroup.dragFilesHere')}</h5>
                                    
                                    <!-- Êñá‰ª∂ÈÄâÊã©ÊåâÈíÆ -->
                                    <div class="upload-buttons">
                                        <button 
                                            class="upload-btn folder-btn" 
                                            on:click={() => document.getElementById('function-folder-input').click()}
                                            title={t('functionGroup.selectFolder')}
                                        >
                                            üìÅ
                                        </button>
                                        <button 
                                            class="upload-btn file-btn" 
                                            on:click={() => document.getElementById('function-file-input').click()}
                                            title={t('functionGroup.selectFiles')}
                                        >
                                            üìÑ
                                        </button>
                                    </div>
                                    
                                    <!-- ‰∏ä‰º†ÈÖçÁΩÆË°å -->
                                    <div class="upload-config-row">
                                        <!-- ‰∏ä‰º†Ê®°ÂºèÈÄâÊã© -->
                                        <div class="upload-mode">
                                            <label for="function-upload-mode-select">{t('functionGroup.mode')}:</label>
                                            <select id="function-upload-mode-select" bind:value={uploadMode} class="b3-select">
                                                <option value="stream">{t('functionGroup.stream')}</option>
                                                <option value="form">{t('functionGroup.form')}</option>
                                            </select>
                                        </div>
                                        
                                        <!-- ‰∏ä‰º†ÈÄâÈ°π -->
                                        <div class="upload-options">
                                            <label class="upload-checkbox">
                                                <input type="checkbox" bind:checked={addAsTask} />
                                                <span>{t('functionGroup.addAsTask')}</span>
                                            </label>
                                            <label class="upload-checkbox">
                                                <input type="checkbox" bind:checked={overwriteExisting} />
                                                <span>{t('functionGroup.overwriteExistingFiles')}</span>
                                            </label>
                                            <label class="upload-checkbox">
                                                <input type="checkbox" bind:checked={tryInstantUpload} />
                                                <span>{t('functionGroup.tryInstantUpload')}</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ÈÄâ‰∏≠ÁöÑÊñá‰ª∂ÂàóË°® -->
                                {#if uploadFiles.length > 0}
                                    <div class="selected-files">
                                        <h5>{t('functionGroup.selectedFilesCount', {count: uploadFiles.length})}:</h5>
                                        <div class="file-list">
                                            {#each uploadFiles as file, index}
                                                <div class="selected-file">
                                                    <span class="file-name">{file.webkitRelativePath || file.name}</span>
                                                    <span class="file-size">({formatFileSize(file.size)})</span>
                                                    <button class="remove-btn" on:click={() => removeFile(index)}>‚úï</button>
                                                </div>
                                            {/each}
                                        </div>
                                    </div>
                                {/if}
                                
                                <!-- ‰∏ä‰º†ËøõÂ∫¶ -->
                                {#if isUploading}
                                    <div class="upload-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: {uploadProgress}%"></div>
                                        </div>
                                        <span class="progress-text">{uploadProgress}%</span>
                                    </div>
                                {/if}
                                
                                <!-- ‰∏ä‰º†ÊåâÈíÆ -->
                                <div class="upload-actions">
                                    <button 
                                        class="b3-button b3-button--primary" 
                                        on:click={uploadFilesToAList} 
                                        disabled={uploadFiles.length === 0 || isUploading}
                                    >
                                        {#if isUploading}
                                            {t('functionGroup.uploading')}
                                        {:else}
                                            {t('functionGroup.startUpload')}
                                        {/if}
                                    </button>
                                </div>
                                </div>
                            {:else if uploadTab === "offline"}
                                <!-- Á¶ªÁ∫ø‰∏ãËΩΩÂå∫Âüü -->
                                <div class="function-section">
                                    <h4>üì• {t('functionGroup.offlineDownloadTo', {path: currentPath})}</h4>
                                    <p class="section-desc">{t('functionGroup.offlineDownloadDesc')}</p>
                                    
                                    <div class="offline-download-area">
                                        <div class="download-input-group">
                                            <label for="download-urls">{t('functionGroup.downloadLinksLabel')}:</label>
                                            <textarea 
                                                id="download-urls"
                                                bind:value={downloadUrls}
                                                placeholder={t('functionGroup.downloadLinksPlaceholder')}
                                                class="b3-text-field download-textarea"
                                                rows="6"
                                                disabled={isOfflineDownloading}
                                            ></textarea>
                                        </div>
                                        
                                        <div class="download-actions">
                                            <button 
                                                class="b3-button b3-button--primary" 
                                                on:click={startOfflineDownload} 
                                                disabled={!downloadUrls.trim() || isOfflineDownloading}
                                            >
                                                {#if isOfflineDownloading}
                                                    {t('functionGroup.adding')}
                                                {:else}
                                                    üì• {t('functionGroup.startOfflineDownload')}
                                                {/if}
                                            </button>
                                        </div>
                                        
                                        <div class="download-tips">
                                            <h5>üí° {t('functionGroup.usageTips')}:</h5>
                                            <ul>
                                                <li>{t('functionGroup.tip1')}</li>
                                                <li>{t('functionGroup.tip2')}</li>
                                                <li>{t('functionGroup.tip3')}</li>
                                                <li>{t('functionGroup.tip4')}</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            {/if}
                        </div>
                    {:else if activeTab === "task"}
                        <div class="task-management">
                            <!-- ‰ªªÂä°ÂàóË°® -->
                            <div class="function-section">
                                <div class="task-header">
                                    <div class="task-title">
                                        <h4>üìã {t('functionGroup.taskList')}</h4>
                                        <p class="section-desc">{t('functionGroup.taskListDesc')}</p>
                                    </div>
                                    <div class="task-actions">
                                        <button 
                                            class="b3-button task-retry-selected-btn" 
                                            on:click={retrySelectedTasks}
                                            disabled={isLoadingTasks || isLoading || selectedTasks.size === 0}
                                            title={t('functionGroup.retrySelectedTasksTitle', {count: selectedTasks.size})}
                                            style="background-color: #4CAF50; color: white;"
                                        >
                                            {t('functionGroup.retrySelected')}
                                        </button>
                                        <button 
                                            class="b3-button task-retry-btn" 
                                            on:click={retryFailedTasks}
                                            disabled={isLoadingTasks || isLoading}
                                            title={t('functionGroup.retryFailedTasksTitle')}
                                            style="background-color: #FF9800; color: white;"
                                        >
                                            {t('functionGroup.retryFailed')}
                                        </button>
                                        <button 
                                            class="b3-button task-clear-btn" 
                                            on:click={clearSucceededTasks}
                                            disabled={isLoadingTasks || isLoading}
                                            title="Clear all successful offline download tasks"
                                            style="background-color: #2196F3; color: white;"
                                        >
                                            {t('functionGroup.clearSuccessful')}
                                        </button>
                                        <button 
                                            class="b3-button task-clear-done-btn" 
                                            on:click={clearDoneTasks}
                                            disabled={isLoadingTasks || isLoading}
                                            title="Clear all completed offline download tasks"
                                            style="background-color: #9C27B0; color: white;"
                                        >
                                            {t('functionGroup.clearCompleted')}
                                        </button>
                                        <button 
                                            class="b3-button b3-button--primary task-refresh-btn" 
                                            on:click={loadUndoneTasks}
                                            disabled={isLoadingTasks}
                                        >
                                            {#if isLoadingTasks}
                                                {t('functionGroup.refreshing')}
                                            {:else}
                                                {t('refresh')}
                                            {/if}
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="task-content">
                                    {#if isLoadingTasks}
                                        <div class="task-loading">
                                            <div class="loading-spinner"></div>
                                            <p>{t('functionGroup.loadingTaskList')}</p>
                                        </div>
                                    {:else if tasks.length === 0}
                                        <div class="task-empty">
                                            <div class="empty-icon">‚úÖ</div>
                                            <p>{t('functionGroup.noTasks')}</p>
                                        </div>
                                    {:else}
                                        <div class="task-table-container">
                                            <table class="task-table">
                                                <thead>
                                                    <tr>
                                                        <th class="task-checkbox-col">
                                                            <input 
                                                                type="checkbox" 
                                                                checked={selectedTasks.size === tasks.length && tasks.length > 0}
                                                                on:change={toggleAllTasks}
                                                            />
                                                        </th>
                                                        <th class="task-status-col">{t('functionGroup.status')}</th>
                                        <th class="task-creator-col">{t('functionGroup.creator')}</th>
                                        <th class="task-name-col">{t('functionGroup.name')}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {#each tasks as task}
                                                        <tr class="task-row" class:selected={selectedTasks.has(task.id || task.name)}>
                                                            <td class="task-checkbox-col">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={selectedTasks.has(task.id || task.name)}
                                                                    on:change={() => toggleTaskSelection(task.id || task.name)}
                                                                />
                                                            </td>
                                                            <td class="task-status-col">
                                                <span class="task-status-icon">
                                                    {#if task.state === 2}
                                                        ‚úÖ
                                                    {:else if task.state === 7}
                                                        ‚ùå
                                                    {:else}
                                                        üîÑ
                                                    {/if}
                                                </span>
                                            </td>
                                                            <td class="task-creator-col">
                                                                <span class="task-creator">{task.creator || 'admin'}</span>
                                                            </td>
                                                            <td class="task-name-col">
                                                <span class="task-name-text" title="{task.name || t('errors.unknownTask')}">
                                                    {formatTaskName(task.name)}
                                                </span>
                                            </td>
                                                        </tr>
                                                    {/each}
                                                </tbody>
                                            </table>
                                        </div>
                                    {/if}
                                </div>
                            </div>
                        </div>
                    {/if}
                    
                    <!-- ÈîôËØØ‰ø°ÊÅØ -->
                    {#if error}
                        <div class="function-error">{error}</div>
                    {/if}
                </div>
                
                <div class="function-footer">
                    <button class="b3-button" on:click={closeFunctionGroupDialog}>
                        {t('close')}
                    </button>
                </div>
            </div>
        </div>
    {/if}

    <!-- È¢ÑËßàÂØπËØùÊ°Ü -->
    {#if showPreview}
        <div class="preview-overlay" on:click={closePreview}>
            <div class="preview-dialog" on:click|stopPropagation>
                <div class="preview-header">
                    <h3>üëÅÔ∏è {t('preview')}: {previewFile?.name}</h3>
                    <button class="close-btn" on:click={closePreview}>‚úï</button>
                </div>
                
                <div class="preview-body">
                    {#if isLoadingPreview}
                        <div class="preview-loading">
                            <div class="loading-spinner"></div>
                            <span>{t('functionGroup.loadingPreview')}</span>
                        </div>
                    {:else}
                        <div class="preview-content">
                            {@html previewContent}
                        </div>
                    {/if}
                </div>
                
                <div class="preview-footer">
                    <button class="b3-button" on:click={closePreview}>
                        {t('close')}
                    </button>
                </div>
            </div>
        </div>
    {/if}

    <!-- ÁßªÂä®ÂØπËØùÊ°Ü -->
    {#if showMoveDialog}
        <div class="preview-overlay" on:click={closeMoveDialog}>
            <div class="preview-dialog" on:click|stopPropagation style="max-width: 600px; max-height: 80vh;">
                <div class="preview-header">
                    <h3>üìÅ {t('functionGroup.moveFileFolder', {item: moveItem})}</h3>
                    <button class="close-btn" on:click={closeMoveDialog}>‚úï</button>
                </div>
                
                <div class="preview-body" style="padding: 20px;">
                    {#if isLoadingFolderTree}
                        <div class="preview-loading">
                            <div class="loading-spinner"></div>
                            <span>{t('functionGroup.loadingFolderTree')}</span>
                        </div>
                    {:else}
                        <div class="move-content">
                            <div class="move-section">
                                <h4>{t('functionGroup.selectTargetFolder')}:</h4>
                                <div class="folder-tree">
                                    <!-- Ê†πÁõÆÂΩïÈÄâÈ°π -->
                                    <div class="folder-item root-folder" 
                                         class:selected={moveTargetPath === "/"}
                                         on:click={() => moveTargetPath = "/"}>
                                        <div class="folder-content">
                                            <span class="folder-name">/</span>
                                        </div>
                                    </div>
                                    <!-- ÈÄíÂΩíÊ∏≤ÊüìÊñá‰ª∂Â§πÊ†ë -->
                                    {#each folderTree as folder}
                                        {#each renderFolderTree(folder, 0) as {folder: currentFolder, prefix}}
                                            <div class="folder-item" 
                                                 class:selected={moveTargetPath === currentFolder.path}>
                                                <div class="folder-content"
                                                     on:click={() => {
                                                         moveTargetPath = currentFolder.path;
                                                         if (currentFolder.hasChildren) {
                                                             toggleFolder(currentFolder);
                                                         }
                                                     }}>
                                                    <span class="tree-prefix">{prefix}</span>
                                                    {#if currentFolder.hasChildren}
                                                        <span class="folder-toggle" 
                                                              on:click|stopPropagation={() => toggleFolder(currentFolder)}>
                                                            {#if loadingSubfolders.has(currentFolder.path)}
                                                                [‚ãØ]
                                                            {:else}
                                                                {currentFolder.isExpanded ? '[-]' : '[+]'}
                                                            {/if}
                                                        </span>
                                                    {:else}
                                                        <span class="folder-toggle"></span>
                                                    {/if}
                                                    <span class="folder-name">{currentFolder.name}</span>
                                                </div>
                                            </div>
                                        {/each}
                                    {/each}
                                </div>
                            </div>
                            
                            <div class="move-options">
                                <label class="option-item">
                                    <input 
                                        type="checkbox" 
                                        bind:checked={allowOverwrite}
                                    />
                                    <span>{t('functionGroup.allowOverwrite')}</span>
                                </label>
                            </div>
                            
                            {#if error}
                                <div class="move-error">{error}</div>
                            {/if}
                        </div>
                    {/if}
                </div>
                
                <div class="preview-footer">
                    <button class="b3-button" on:click={closeMoveDialog}>
                        {t('cancel')}
                    </button>
                    <button 
                        class="b3-button b3-button--primary" 
                        on:click={executeMove}
                        disabled={isMoving || !moveTargetPath || isLoadingFolderTree}
                    >
                        {#if isMoving}
                            {t('functionGroup.moving')}
                                    {:else}
                                        {t('functionGroup.confirmMove')}
                        {/if}
                    </button>
                </div>
            </div>
        </div>
    {/if}


</div>

<style lang="scss">
    .alist-browser {
        height: 100%;
        display: flex;
        flex-direction: column;
        background: var(--b3-theme-background);
    }

    .alist-header {
        padding: 8px;
        border-bottom: 1px solid var(--b3-theme-surface-lighter);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--b3-theme-surface);
    }

    .alist-path {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }

    .alist-current-path {
        font-size: 12px;
        color: var(--b3-theme-on-surface);
        background: var(--b3-theme-surface-lighter);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: var(--b3-font-family-code);
    }

    .alist-content {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }

    .alist-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        gap: 12px;
    }

    .loading-spinner {
        width: 24px;
        height: 24px;
        border: 2px solid var(--b3-theme-surface-lighter);
        border-top: 2px solid var(--b3-theme-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .alist-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        gap: 12px;
        text-align: center;
    }

    .error-icon {
        font-size: 32px;
    }

    .error-message {
        color: var(--b3-theme-error);
        font-size: 14px;
    }

    .alist-welcome {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 300px;
        gap: 16px;
        text-align: center;
    }

    .welcome-icon {
        font-size: 48px;
    }

    .alist-welcome h3 {
        margin: 0;
        color: var(--b3-theme-on-surface);
    }

    .alist-welcome p {
        margin: 0;
        color: var(--b3-theme-on-surface-light);
        font-size: 14px;
    }

    .alist-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        gap: 12px;
    }

    .empty-icon {
        font-size: 32px;
    }

    .alist-file-list {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .alist-file-item {
        display: flex;
        align-items: center;
        padding: 8px;
        border-radius: 4px;
        transition: background-color 0.2s;

        &:hover {
            background: var(--b3-theme-surface-lighter);
            
            .file-actions {
                opacity: 1;
            }
        }

        &.is-directory {
            .file-name {
                color: var(--b3-theme-primary);
            }
        }
    }

    .file-actions {
        margin-left: auto;
        opacity: 0;
        transition: opacity 0.2s;
        
        .preview-btn {
            font-size: 12px;
            padding: 2px 6px;
        }
    }

    .file-icon {
        font-size: 16px;
        width: 20px;
        text-align: center;
    }

    .file-info {
        flex: 1;
        min-width: 0;
    }

    .file-name {
        font-size: 14px;
        color: var(--b3-theme-on-surface);
        word-break: break-all;
        line-height: 1.3;

        &.clickable {
            cursor: pointer;
            color: var(--b3-theme-primary);

            &:hover {
                text-decoration: underline;
            }
        }
    }

    .file-meta {
        display: flex;
        gap: 8px;
        font-size: 11px;
        color: var(--b3-theme-on-surface-light);
        margin-top: 2px;
    }

    .file-size {
        font-family: var(--b3-font-family-code);
    }

    .file-date {
        font-family: var(--b3-font-family-code);
    }

    /* ‰∏ä‰º†ÂØπËØùÊ°ÜÊ†∑Âºè */
    .upload-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .upload-dialog {
        background: var(--b3-theme-background);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .upload-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--b3-theme-surface-lighter);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--b3-theme-surface);
    }

    .upload-header h3 {
        margin: 0;
        font-size: 16px;
        color: var(--b3-theme-on-surface);
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: var(--b3-theme-on-surface-light);
        padding: 4px;
        border-radius: 4px;
        transition: background-color 0.2s;

        &:hover {
            background: var(--b3-theme-surface-lighter);
        }
    }

    .upload-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }

    .upload-drop-zone {
        border: 2px dashed var(--b3-theme-surface-lighter);
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        margin-bottom: 16px;
        transition: border-color 0.2s;

        &:hover {
            border-color: var(--b3-theme-primary);
        }
    }

    .upload-drop-zone h4 {
        margin: 0 0 16px 0;
        color: var(--b3-theme-on-surface);
        font-size: 14px;
    }

    .upload-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-bottom: 16px;
    }

    .upload-btn {
        width: 60px;
        height: 60px;
        border: 2px solid var(--b3-theme-surface-lighter);
        border-radius: 8px;
        background: var(--b3-theme-surface);
        cursor: pointer;
        font-size: 24px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;

        &:hover {
            border-color: var(--b3-theme-primary);
            background: var(--b3-theme-primary-lighter);
        }
    }

    .upload-config-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 16px;
        padding: 12px;
        background: var(--b3-theme-surface);
        border-radius: 6px;
    }

    .upload-mode {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--b3-theme-on-surface);
        
        label {
            margin: 0;
            font-weight: 500;
        }
        
        .b3-select {
            min-width: 80px;
        }
    }

    .upload-options {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
    }

    .upload-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--b3-theme-on-surface);
        cursor: pointer;

        input[type="checkbox"] {
            margin: 0;
        }
    }

    .selected-files {
        margin-top: 16px;
        padding: 16px;
        background: var(--b3-theme-surface);
        border-radius: 6px;
    }

    .selected-files h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: var(--b3-theme-on-surface);
    }

    .file-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .selected-file {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 4px;
        background: var(--b3-theme-background);
    }

    .selected-file .file-name {
        flex: 1;
        font-size: 13px;
        color: var(--b3-theme-on-surface);
        word-break: break-all;
    }

    .selected-file .file-size {
        font-size: 12px;
        color: var(--b3-theme-on-surface-light);
        font-family: var(--b3-font-family-code);
    }

    .remove-btn {
        background: none;
        border: none;
        color: var(--b3-theme-error);
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
        transition: background-color 0.2s;

        &:hover {
            background: var(--b3-theme-error-lighter);
        }
    }

    .upload-progress {
        margin-top: 16px;
        padding: 12px;
        background: var(--b3-theme-surface);
        border-radius: 6px;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--b3-theme-surface-lighter);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .progress-fill {
        height: 100%;
        background: var(--b3-theme-primary);
        transition: width 0.3s ease;
    }

    .progress-text {
        font-size: 12px;
        color: var(--b3-theme-on-surface);
        text-align: center;
        display: block;
    }

    .upload-error {
        margin-top: 12px;
        padding: 12px;
        background: var(--b3-theme-error-lighter);
        color: var(--b3-theme-error);
        border-radius: 6px;
        font-size: 14px;
        text-align: center;
    }

    .upload-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--b3-theme-surface-lighter);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        background: var(--b3-theme-surface);
    }

    /* ÂäüËÉΩÁªÑÂØπËØùÊ°ÜÊ†∑Âºè */
    .function-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .function-dialog {
        background: var(--b3-theme-background);
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--b3-theme-surface-lighter);
    }
    
    .function-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--b3-theme-surface-lighter);
        background: var(--b3-theme-surface);
    }
    
    .function-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--b3-theme-on-surface);
    }
    
    .function-tabs {
        display: flex;
        border-bottom: 1px solid var(--b3-theme-surface-lighter);
        background: var(--b3-theme-surface);
    }
    
    .tab-btn {
        background: none;
        border: none;
        padding: 12px 20px;
        cursor: pointer;
        color: var(--b3-theme-on-surface-light);
        font-size: 14px;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }
    
    .tab-btn:hover {
        background: var(--b3-theme-surface-lighter);
        color: var(--b3-theme-on-surface);
    }
    
    .tab-btn.active {
        color: var(--b3-theme-primary);
        border-bottom-color: var(--b3-theme-primary);
        background: var(--b3-theme-background);
    }
    
    .function-body {
        padding: 20px;
        max-height: 50vh;
        overflow-y: auto;
    }
    
    .function-section {
        margin-bottom: 24px;
    }
    
    .function-section:last-child {
        margin-bottom: 0;
    }
    
    .function-section h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--b3-theme-on-surface);
    }
    
    .section-desc {
        margin: 0 0 12px 0;
        font-size: 12px;
        color: var(--b3-theme-on-surface-light);
    }
    
    .input-group {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .input-group input {
        flex: 1;
        min-width: 0;
    }
    
    .folder-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--b3-theme-surface-lighter);
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 12px;
    }
    
    .folder-item {
        display: flex;
        align-items: center;
        padding: 6px 8px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .folder-item:hover {
        background: var(--b3-theme-surface-lighter);
    }
    
    .folder-item input[type="checkbox"] {
        margin-right: 8px;
    }
    
    .folder-name {
        font-size: 13px;
        color: var(--b3-theme-on-surface);
    }
    
    .no-folders {
        text-align: center;
        color: var(--b3-theme-on-surface-light);
        font-size: 13px;
        padding: 20px;
        margin: 0;
    }
    
    .delete-actions {
        padding: 12px;
        background: var(--b3-theme-surface);
        border-radius: 4px;
        border: 1px solid var(--b3-theme-surface-lighter);
    }
    
    .selected-count {
        margin: 0 0 8px 0;
        font-size: 12px;
        color: var(--b3-theme-on-surface-light);
    }
    
    .file-action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .file-action-buttons .b3-button {
        flex-shrink: 0;
    }
    
    .function-error {
        background: var(--b3-theme-error-lighter);
        color: var(--b3-theme-error);
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        margin-top: 12px;
    }
    
    .function-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--b3-theme-surface-lighter);
        background: var(--b3-theme-surface);
        display: flex;
        justify-content: flex-end;
    }

    /* ‰∏ä‰º†ÊñπÂºèÊ†áÁ≠æÈ°µÊ†∑Âºè */
    .upload-method-tabs {
        display: flex;
        border-bottom: 1px solid var(--b3-theme-surface-lighter);
        background: var(--b3-theme-surface);
        margin: -20px -20px 20px -20px;
        border-radius: 0;
    }
    
    .upload-method-tab {
        background: none;
        border: none;
        padding: 12px 20px;
        cursor: pointer;
        color: var(--b3-theme-on-surface-light);
        font-size: 14px;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        flex: 1;
        text-align: center;
    }
    
    .upload-method-tab:hover {
        background: var(--b3-theme-surface-lighter);
        color: var(--b3-theme-on-surface);
    }
    
    .upload-method-tab.active {
        color: var(--b3-theme-primary);
        border-bottom-color: var(--b3-theme-primary);
        background: var(--b3-theme-background);
        font-weight: 500;
    }

    /* Âà†Èô§Êñá‰ª∂ÂäüËÉΩÊ†∑Âºè */
    .file-selection {
        margin-top: 12px;
    }

    .file-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--b3-theme-surface-lighter);
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 12px;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 6px 8px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
        gap: 8px;
    }

    .file-item:hover {
        background: var(--b3-theme-surface-lighter);
    }

    .file-item input[type="checkbox"] {
        margin: 0;
    }

    .file-item .file-icon {
        font-size: 14px;
    }

    .file-item .file-name {
        flex: 1;
        font-size: 13px;
        color: var(--b3-theme-on-surface);
        word-break: break-all;
    }

    .file-item .file-size {
        font-size: 11px;
        color: var(--b3-theme-on-surface-light);
        font-family: var(--b3-font-family-code);
    }

    .no-files {
        text-align: center;
        color: var(--b3-theme-on-surface-light);
        font-size: 13px;
        padding: 20px;
        margin: 0;
    }

    /* ‰∏ä‰º†ÂäüËÉΩÂú®ÂäüËÉΩÁªÑ‰∏≠ÁöÑÊ†∑Âºè */
    .upload-management .upload-drop-zone {
        border: 2px dashed var(--b3-theme-surface-lighter);
        border-radius: 6px;
        padding: 16px;
        text-align: center;
        margin-bottom: 12px;
    }

    .upload-management .upload-drop-zone h5 {
        margin: 0 0 12px 0;
        font-size: 13px;
        color: var(--b3-theme-on-surface);
    }

    .upload-management .upload-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-bottom: 12px;
    }

    .upload-management .upload-btn {
        width: 40px;
        height: 40px;
        border: 1px solid var(--b3-theme-surface-lighter);
        border-radius: 6px;
        background: var(--b3-theme-surface);
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .upload-management .upload-btn:hover {
        border-color: var(--b3-theme-primary);
        background: var(--b3-theme-primary-lighter);
    }

    .upload-management .selected-files {
        margin-top: 12px;
        padding: 12px;
        background: var(--b3-theme-surface);
        border-radius: 4px;
    }

    .upload-management .selected-files h5 {
        margin: 0 0 8px 0;
        font-size: 13px;
        color: var(--b3-theme-on-surface);
    }

    .upload-actions {
        margin-top: 12px;
        text-align: center;
    }

    // È¢ÑËßàÂØπËØùÊ°ÜÊ†∑Âºè
    .preview-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .preview-dialog {
        background: var(--b3-theme-background);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        width: 95vw;
        max-width: 1200px;
        max-height: 95vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .preview-header {
        padding: 16px;
        border-bottom: 1px solid var(--b3-theme-surface-lighter);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--b3-theme-surface);

        h3 {
            margin: 0;
            font-size: 16px;
            color: var(--b3-theme-on-surface);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--b3-theme-on-surface);
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;

            &:hover {
                background: var(--b3-theme-surface-lighter);
            }
        }
    }

    .preview-body {
        flex: 1;
        padding: 16px;
        overflow: auto;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .preview-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        color: var(--b3-theme-on-surface);
    }

    .preview-content {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        
        // ÈáçÁΩÆAListÈ¢ÑËßàÂÜÖÂÆπÁöÑÊ†∑Âºè‰ª•ÈÄÇÂ∫îÊÄùÊ∫ê‰∏ªÈ¢ò
        :global(.obj-box) {
            background: var(--b3-theme-surface) !important;
            border-radius: 8px;
            padding: 16px;
            margin: 16px;
            width: calc(100% - 32px) !important;
            height: calc(100% - 32px) !important;
            display: flex !important;
            flex-direction: column !important;
            box-sizing: border-box !important;
        }
        
        :global(.hope-stack) {
            width: 100% !important;
            height: 100% !important;
            flex: 1 !important;
        }
        
        // ÂõæÁâáÊ†∑Âºè - ‰øùÊåÅËæπË∑ùÂíåÂêàÈÄÇÂ∞∫ÂØ∏
        :global(.hope-image) {
            max-width: calc(100% - 32px);
            max-height: calc(100% - 32px);
            height: auto;
            border-radius: 4px;
            object-fit: contain;
            margin: 16px;
        }
        
        // PDFÂíåOfficeÊñáÊ°£Ê†∑Âºè - A4Á∫∏Âº†ÊØî‰æãÂíåË∂≥Â§üÈ´òÂ∫¶
        :global(iframe) {
            width: calc(100% - 32px) !important;
            height: calc(100vh - 200px) !important;
            min-height: 600px !important;
            margin: 16px !important;
            border: none !important;
            border-radius: 4px !important;
        }
        
        // ËßÜÈ¢ëÊ†∑Âºè - ‰øùÊåÅËæπË∑ùÂíåÊí≠ÊîæÊéß‰ª∂ÂèØËßÅ
        :global(video) {
            max-width: calc(100% - 32px) !important;
            max-height: calc(100% - 64px) !important;
            height: auto;
            margin: 16px !important;
            border-radius: 4px !important;
        }
        
        // ÊñáÊú¨ÂíåMarkdownÂÜÖÂÆπÊ†∑Âºè - A4Á∫∏Âº†ÊØî‰æã
         :global(.text-content), :global(.markdown-content) {
             max-width: 800px !important;
             width: 100% !important;
             height: calc(100vh - 200px) !important;
             min-height: 600px !important;
             margin: 16px auto !important;
             padding: 20px !important;
             background: var(--b3-theme-background) !important;
             border: 1px solid var(--b3-theme-surface-lighter) !important;
             border-radius: 4px !important;
             overflow-y: auto !important;
             font-family: var(--b3-font-family-code) !important;
             font-size: 14px !important;
             line-height: 1.6 !important;
             white-space: pre-wrap !important;
             word-wrap: break-word !important;
             box-sizing: border-box !important;
         }
         
         // MarkdownÂÜÖÂÆπÁâπÊÆäÊ†∑Âºè
         :global(.markdown-content) {
             font-family: var(--b3-font-family) !important;
         }
         
         :global(.markdown-content h1),
         :global(.markdown-content h2),
         :global(.markdown-content h3),
         :global(.markdown-content h4),
         :global(.markdown-content h5),
         :global(.markdown-content h6) {
             color: var(--b3-theme-on-background) !important;
             margin: 16px 0 8px 0 !important;
         }
         
         :global(.markdown-content p) {
             margin: 8px 0 !important;
             color: var(--b3-theme-on-background) !important;
         }
         
         :global(.markdown-content code) {
             background: var(--b3-theme-surface) !important;
             padding: 2px 4px !important;
             border-radius: 3px !important;
             font-family: var(--b3-font-family-code) !important;
         }
         
         :global(.markdown-content pre) {
             background: var(--b3-theme-surface) !important;
             padding: 12px !important;
             border-radius: 4px !important;
             overflow-x: auto !important;
             margin: 12px 0 !important;
         }

    }

    .preview-footer {
        padding: 16px;
        border-top: 1px solid var(--b3-theme-surface-lighter);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        background: var(--b3-theme-surface-lighter);
        
        .b3-button {
             min-width: 80px;
             padding: 8px 16px;
             
             &:not(.b3-button--primary) {
                 background: var(--b3-theme-surface);
                 border: 1px solid var(--b3-theme-surface-lighter);
                 color: var(--b3-theme-on-surface);
                 
                 &:hover {
                     background: var(--b3-theme-surface-lighter);
                     color: var(--b3-theme-on-surface);
                 }
             }
         }
    }

    // Á¶ªÁ∫ø‰∏ãËΩΩÊ†∑Âºè
    .offline-download-area {
        padding: 16px;
        background: var(--b3-theme-surface);
        border-radius: 6px;
        margin-top: 12px;
    }

    .download-input-group {
        margin-bottom: 16px;

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--b3-theme-on-surface);
            font-weight: 500;
        }
    }

    .download-textarea {
        width: 100%;
        min-height: 120px;
        resize: vertical;
        font-family: var(--b3-font-family-code);
        font-size: 12px;
        line-height: 1.4;
    }

    .download-actions {
        margin-bottom: 16px;
        text-align: center;
    }

    .download-tips {
        background: var(--b3-theme-surface-lighter);
        padding: 12px;
        border-radius: 4px;
        border-left: 3px solid var(--b3-theme-primary);

        h5 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: var(--b3-theme-on-surface);
        }

        ul {
            margin: 0;
            padding-left: 16px;
            font-size: 12px;
            color: var(--b3-theme-on-surface-light);
            line-height: 1.4;

            li {
                margin-bottom: 4px;
            }
        }
    }

    // ‰ªªÂä°ÂàóË°®Ê†∑Âºè
    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
        gap: 16px;
    }

    .task-title {
        flex: 1;
        
        h4 {
            margin: 0 0 4px 0;
        }
        
        .section-desc {
            margin: 0;
        }
    }

    .task-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
        align-self: flex-start;
        margin-top: 2px;
    }

    .task-refresh-btn {
        flex-shrink: 0;
    }

    .task-clear-btn {
        flex-shrink: 0;
    }

    .task-retry-selected-btn {
        flex-shrink: 0;
    }

    .task-retry-btn {
        flex-shrink: 0;
    }

    .task-clear-done-btn {
        flex-shrink: 0;
    }

    .task-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        gap: 12px;
        color: var(--b3-theme-on-surface);
    }

    .task-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        gap: 12px;
        color: var(--b3-theme-on-surface-light);

        .empty-icon {
            font-size: 32px;
        }
    }

    .task-table {
        width: 100%;
        border-collapse: collapse;
        max-height: 400px;
        overflow-y: auto;
        display: block;
        border: 1px solid var(--b3-theme-surface-lighter);
        border-radius: 6px;
    }

    .task-table thead {
        display: table;
        width: 100%;
        table-layout: fixed;
        background: var(--b3-theme-surface-lighter);
    }

    .task-table tbody {
        display: block;
        max-height: 350px;
        overflow-y: auto;
        width: 100%;
    }

    .task-table tr {
        display: table;
        width: 100%;
        table-layout: fixed;
    }

    .task-table th,
    .task-table td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid var(--b3-theme-surface-lighter);
        vertical-align: middle;
    }

    .task-table th {
        font-size: 12px;
        font-weight: 600;
        color: var(--b3-theme-on-surface);
        background: var(--b3-theme-surface-lighter);
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .task-table td {
        font-size: 13px;
        color: var(--b3-theme-on-surface);
    }

    .task-table .task-checkbox-col {
        width: 10%;
        text-align: center;
    }

    .task-table .task-status-col {
        width: 10%;
    }

    .task-table .task-creator-col {
        width: 15%;
    }

    .task-table .task-name-col {
        width: 65%;
        min-width: 200px;
    }

    .task-table tbody tr:hover {
        background: var(--b3-theme-surface-lighter);
    }

    .task-table tbody tr:last-child td {
        border-bottom: none;
    }

    

    .task-status-icon {
        font-size: 16px;
        display: inline-block;
        text-align: center;
    }

    .task-name-text {
        word-break: break-all;
        line-height: 1.3;
    }

    .task-creator {
        font-size: 12px;
        color: var(--b3-theme-on-surface-light);
    }

    // ÁßªÂä®ÂØπËØùÊ°ÜÊ†∑Âºè
    .move-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .move-section {
        h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: var(--b3-theme-on-surface);
            font-weight: 600;
        }
    }

    .folder-tree {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--b3-theme-surface-lighter);
        border-radius: 6px;
        padding: 12px;
        background: var(--b3-theme-surface);
        width: 100%;
        font-family: var(--b3-font-family-code);
        font-size: 13px;
        line-height: 1.2;
    }

    .folder-item {
        margin: 0;
        border-radius: 0;
        transition: background-color 0.2s;
        line-height: 1.2;
        font-family: var(--b3-font-family-code);
        white-space: nowrap;

        &.selected {
            background: var(--b3-theme-primary-lighter);
            color: var(--b3-theme-primary);
        }

        &.root-folder {
            padding: 4px 0;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 1px solid var(--b3-theme-surface-lighter);
            margin-bottom: 8px;

            &:hover {
                background: var(--b3-theme-surface-lighter);
            }
        }

        &:hover {
            background: var(--b3-theme-surface-lighter);
        }
    }

    .folder-content {
        padding: 2px 0;
        cursor: pointer;
        user-select: none;
        font-family: var(--b3-font-family-code);
        color: var(--b3-theme-on-surface);
    }

    .folder-toggle {
        display: inline;
        font-size: 13px;
        cursor: pointer;
        user-select: none;
        color: var(--b3-theme-on-surface);
        margin-right: 1ch;
    }

    .folder-name {
        display: inline;
        font-size: 13px;
        color: var(--b3-theme-on-surface);
        cursor: pointer;
        user-select: none;
    }

    .tree-prefix {
        color: var(--b3-theme-on-surface-light);
        font-family: var(--b3-font-family-code);
        white-space: pre;
    }

    .move-options {
        padding: 12px;
        background: var(--b3-theme-surface-lighter);
        border-radius: 6px;
        border-left: 3px solid var(--b3-theme-primary);
    }

    .option-item {
        display: flex;
        align-items: center;
        cursor: pointer;
        
        input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        span {
            font-size: 13px;
            color: var(--b3-theme-on-surface);
            user-select: none;
        }
    }

    .move-error {
        padding: 8px 12px;
        background: var(--b3-theme-error-lighter);
        color: var(--b3-theme-error);
        border-radius: 4px;
        font-size: 12px;
        border-left: 3px solid var(--b3-theme-error);
    }
</style>

